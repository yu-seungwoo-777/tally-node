# 아키텍처

**작성일**: 2025-12-23
**버전**: 3.0 (5계층 아키텍처)

---

## 개요

ESP32-S3 (EoRa-S3) 기반 LoRa 통신 프로젝트의 5계층 아키텍처입니다.

---

## 계층 구조

```
┌─────────────────────────────────────────────────────────┐
│ 01_app (앱)                                             │
│ - lora_test: LoRa 테스트 앱                            │
└─────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────┐
│ 02_presentation (프레젠테이션)                         │
│ - (비어있음)                                            │
└─────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────┐
│ 03_service (서비스)                                     │
│ - button_service: 버튼 이벤트 관리                     │
│ - lora_service: LoRa 통신 서비스                       │
└─────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────┐
│ 04_driver (드라이버)                                    │
│ - button_poll: 버튼 폴링 (GPIO)                        │
│ - lora_driver: RadioLib 래퍼                           │
└─────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────┐
│ 05_hal (하드웨어 추상화)                               │
│ - lora_hal: SX1262 하드웨어 제어                        │
└─────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────┐
│ 00_common (공통)                                        │
│ - event_bus: 이벤트 버스 시스템                         │
└─────────────────────────────────────────────────────────┘
```

---

## 의존성 규칙

### 1. 인접한 계층만 의존 (레이어 건너뛰기 금지)

하위 계층은 반드시 **인접한 상위 계층**을 통해서만 접근해야 합니다.

```
O 올바른 예:
01_app → 03_service
03_service → 04_driver
04_driver → 05_hal

X 잘못된 예 (건너뛰기):
01_app → 04_driver  (03_service를 거쳐야 함)
01_app → 05_hal     (03, 04를 거쳐야 함)
03_service → 00_common  (04, 05를 거쳐야 함)
```

### 2. event_bus로 느슨한 결합 (Loose Coupling)

**event_bus 역할**: 컴포넌트 간 직접 의존을 피하고 느슨한 결합을 제공

```
┌─────────────────────────────────────────────────────┐
│ 01_app (lora_test)                                  │
│   - event_bus 구독 (subscribe)                      │
│   - lora_service 이벤트 수신                         │
└─────────────────────────────────────────────────────┘
                       ▲
                       │ event
                       │
┌─────────────────────────────────────────────────────┐
│ 03_service (lora_service)                           │
│   - event_bus에 이벤트 발행 (publish)               │
│   - 01_app과 직접 의존하지 않음                      │
└─────────────────────────────────────────────────────┘
```

**사용 예시:**
- 하위 계층: `event_bus_publish(EVT_LORA_PACKET_RECEIVED, &data, size);`
- 상위 계층: `event_bus_subscribe(EVT_LORA_PACKET_RECEIVED, callback);`

---

## 컴포넌트 상세

### 00_common - 공통

| 컴포넌트 | 역할 | 의존성 |
|---------|------|--------|
| event_bus | 컴포넌트 간 이벤트 기반 통신 | freertos |

### 01_app - 앱

| 컴포넌트 | 역할 | 의존성 |
|---------|------|--------|
| lora_test | LoRa 테스트 앱 | button_service, lora_service, event_bus |

### 02_presentation - 프레젠테이션

(비어있음)

### 03_service - 서비스

| 컴포넌트 | 역할 | 의존성 |
|---------|------|--------|
| button_service | 버튼 폴링 관리 | button_poll |
| lora_service | LoRa 통신 서비스 | lora_driver, event_bus |

### 04_driver - 드라이버

| 컴포넌트 | 역할 | 의존성 |
|---------|------|--------|
| button_poll | GPIO 버튼 폴링 | driver, esp_timer |
| lora_driver | RadioLib 래퍼 | lora_hal, RadioLib |

### 05_hal - 하드웨어 추상화

| 컴포넌트 | 역할 | 의존성 |
|---------|------|--------|
| lora_hal | LoRa 하드웨어 제어 (SX1262) | driver |

---

## 의존성 그래프

```
lora_test (01_app)
    │
    ├─→ button_service (03_service)
    │       └─→ button_poll (04_driver)
    │               └─→ driver, esp_timer
    │
    └─→ lora_service (03_service)
            └─→ lora_driver (04_driver)
                    └─→ lora_hal (05_hal)
                            └─→ driver
            └─→ event_bus (00_common)
```

---

## 버튼 동작

| 액션 | 시간 | 동작 |
|------|------|------|
| 단일 클릭 | < 1000ms | "Test" 메시지 송신 |
| 롱 프레스 | ≥ 1000ms | 통계 출력 (송신/수신/RSSI/SNR) |

---

## LoRa 설정

| 파라미터 | 값 |
|---------|-----|
| 주파수 | 923.0 MHz |
| 대역폭 | 250.0 kHz |
| 확성 계수 | 9 |
| 코딩 레이트 | 5 |
| 송신 전력 | 22 dBm |
| 동기 워드 | 0x12 |

---

## 하드웨어

| 항목 | 값 |
|------|-----|
| 보드 | EoRa-S3 (ESP32-S3) |
| LoRa 칩 | SX1262 |
| 버튼 | GPIO_NUM_0 (내장 BOOT 버튼, Active Low) |
