// Tally Node Web Application
(()=>{function h(){return{_initialized:!1,_statusPollingTimer:null,currentView:"dashboard",viewTitles:{dashboard:"Dashboard",network:"Network",switcher:"Switcher",broadcast:"Broadcast",devices:"Devices",system:"System",license:"License Management"},wsConnected:!1,showBrightnessModal:!1,showLedColorsModal:!1,status:{network:{wifi:{connected:!1,ssid:"",ip:"--"},ethernet:{connected:!1,ip:"--"}},switcher:{dualEnabled:!1,secondaryOffset:4,primary:{connected:!1,type:"ATEM",ip:"",port:0,tally:{pgm:[],pvw:[],raw:"",channels:0}},secondary:{connected:!1,type:"ATEM",ip:"",port:0,tally:{pgm:[],pvw:[],raw:"",channels:0}},combined:{pgm:[],pvw:[],raw:"",channels:0}},system:{deviceId:"0000",battery:0,voltage:0,temperature:0,uptime:0}},network:{wifiConnected:!1,wifiSsid:"",wifiIp:"--",ethEnabled:!1,ethConnected:!1,ethDetected:!1,ethIp:"--",apEnabled:!1,apSsid:"",apChannel:1,apIp:"--"},system:{deviceId:"0000",battery:0,voltage:0,temperature:0,uptime:0,freeHeap:0,version:"2.3.0",loraChipType:1},config:{network:{wifiAp:{ssid:"",channel:1,enabled:!1},wifiSta:{ssid:"",enabled:!1},ethernet:{dhcp:!0,staticIp:"",netmask:"",gateway:"",enabled:!1}},switcher:{primary:{connected:!1,type:"ATEM",ip:"",port:0,interface:2,cameraLimit:0,tally:{pgm:[],pvw:[],raw:"",channels:0}},secondary:{connected:!1,type:"ATEM",ip:"",port:0,interface:1,cameraLimit:0,tally:{pgm:[],pvw:[],raw:"",channels:0}},dualEnabled:!1,secondaryOffset:4},broadcast:{rf:{frequency:868,syncWord:18,spreadingFactor:7,codingRate:7,bandwidth:250,txPower:22}},pollingInterval:2e3},ledColors:{program:{r:255,g:0,b:0},preview:{r:0,g:255,b:0},off:{r:0,g:0,b:0},saving:!1},form:{ap:{ssid:"",password:"",channel:1,enabled:!1},wifi:{ssid:"",password:"",enabled:!1},ethernet:{dhcp:!0,ip:"",gateway:"",netmask:"",enabled:!1},switcher:{primary:{type:"ATEM",ip:"",port:9910,interface:0,cameraLimit:0,password:"",portLocked:!0},secondary:{type:"ATEM",ip:"",port:9910,interface:0,cameraLimit:0,password:"",portLocked:!0},dualEnabled:!1,secondaryOffset:4},mappingOffset:4,display:{brightness:128,cameraId:1},broadcast:{syncCode:18,frequency:868}},viewTitle(){return this.viewTitles[this.currentView]||"TALLY-NODE"},async init(){console.log("Tally App initializing...");let t=window.location.hash.slice(1);t&&["dashboard","network","switcher","broadcast","devices","system","license"].includes(t)&&(this.currentView=t),window.addEventListener("hashchange",()=>{let e=window.location.hash.slice(1);e&&["dashboard","network","switcher","broadcast","devices","system","license"].includes(e)&&(this.currentView=e)}),await this.fetchStatus(),this.$nextTick(()=>{this.initBroadcastModule&&this.initBroadcastModule()}),await this.initDevices(),await this.initLicense(),this.startStatusPolling(),this.$watch("currentView",e=>{e==="system"&&this.notices.list.length===0&&this.fetchNotices()}),this.currentView==="system"&&this.fetchNotices()},async fetchStatus(){try{let t=await fetch("/api/status");if(!t.ok)throw new Error("Status fetch failed");let e=await t.json();if(this.status={...this.status,...e},e.network&&(e.network.ap&&(this.network.apEnabled=e.network.ap.enabled||!1,this.network.apSsid=e.network.ap.ssid||"",this.network.apChannel=e.network.ap.channel||1,this.network.apIp=e.network.ap.ip||"--",this._initialized||(this.form.ap={enabled:e.network.ap.enabled,ssid:e.network.ap.ssid||"",channel:e.network.ap.channel||1,password:e.network.ap.password||""})),e.network.wifi&&(this.network.wifiConnected=e.network.wifi.connected,this.network.wifiSsid=e.network.wifi.ssid||"",this.network.wifiIp=e.network.wifi.ip||"--",this._initialized||(this.form.wifi.enabled=e.network.wifi.enabled,this.form.wifi.ssid=e.network.wifi.ssid||"",this.form.wifi.password=e.network.wifi.password||"")),e.network.ethernet&&(this.network.ethEnabled=e.network.ethernet.enabled||!1,this.network.ethConnected=e.network.ethernet.connected,this.network.ethDetected=e.network.ethernet.detected||!1,this.network.ethIp=e.network.ethernet.ip||"--",this._initialized||(this.form.ethernet.enabled=e.network.ethernet.enabled,this.form.ethernet.dhcp=e.network.ethernet.dhcp,this.form.ethernet.ip=e.network.ethernet.staticIp||"",this.form.ethernet.netmask=e.network.ethernet.netmask||"",this.form.ethernet.gateway=e.network.ethernet.gateway||""))),e.system&&(this.system.deviceId=e.system.deviceId||"0000",this.system.battery=e.system.battery||0,this.system.voltage=e.system.voltage||0,this.system.temperature=e.system.temperature||0,this.system.uptime=e.system.uptime||0,this.system.loraChipType=e.system.loraChipType||1,this.system.version=e.system.version||"2.3.0"),e.switcher){if(this.config.switcher.dualEnabled=e.switcher.dualEnabled||!1,this.config.switcher.secondaryOffset=e.switcher.secondaryOffset||4,this._initialized||(this.form.switcher.dualEnabled=e.switcher.dualEnabled||!1,this.form.switcher.secondaryOffset=e.switcher.secondaryOffset||4,this.form.mappingOffset=e.switcher.secondaryOffset||4),e.switcher.primary){let s={connected:e.switcher.primary.connected||!1,type:e.switcher.primary.type||"ATEM",ip:e.switcher.primary.ip||"",port:e.switcher.primary.port||0,interface:e.switcher.primary.interface||0,cameraLimit:e.switcher.primary.cameraLimit||0,tally:e.switcher.primary.tally||{pgm:[],pvw:[],raw:"",channels:0}};this.config.switcher.primary=s,this.status.switcher||(this.status.switcher={primary:{},secondary:{}}),this.status.switcher.primary={...s},this._initialized||(this.form.switcher.primary.type=e.switcher.primary.type||"ATEM",this.form.switcher.primary.ip=e.switcher.primary.ip||"",this.form.switcher.primary.port=e.switcher.primary.port||9910,this.form.switcher.primary.interface=e.switcher.primary.interface||0,this.form.switcher.primary.cameraLimit=e.switcher.primary.cameraLimit||0,this.form.switcher.primary.password=e.switcher.primary.password||"",this.form.switcher.primary.portLocked=!0)}if(e.switcher.secondary){let s={connected:e.switcher.secondary.connected||!1,type:e.switcher.secondary.type||"ATEM",ip:e.switcher.secondary.ip||"",port:e.switcher.secondary.port||0,interface:e.switcher.secondary.interface||0,cameraLimit:e.switcher.secondary.cameraLimit||0,tally:e.switcher.secondary.tally||{pgm:[],pvw:[],raw:"",channels:0}};this.config.switcher.secondary=s,this.status.switcher||(this.status.switcher={primary:{},secondary:{}}),this.status.switcher.secondary={...s},this._initialized||(this.form.switcher.secondary.type=e.switcher.secondary.type||"ATEM",this.form.switcher.secondary.ip=e.switcher.secondary.ip||"",this.form.switcher.secondary.port=e.switcher.secondary.port||9910,this.form.switcher.secondary.interface=e.switcher.secondary.interface||0,this.form.switcher.secondary.cameraLimit=e.switcher.secondary.cameraLimit||0,this.form.switcher.secondary.password=e.switcher.secondary.password||"",this.form.switcher.secondary.portLocked=!0)}if(e.switcher.combined){let s={pgm:e.switcher.combined.pgm||[],pvw:e.switcher.combined.pvw||[],raw:e.switcher.combined.raw||"",channels:e.switcher.combined.channels||0};this.status.switcher||(this.status.switcher={}),this.status.switcher.combined={...s}}else this.status.switcher||(this.status.switcher={}),this.status.switcher.combined||(this.status.switcher.combined={pgm:[],pvw:[],raw:"",channels:0})}e.broadcast&&e.broadcast.rf?(this.config.broadcast.rf={frequency:e.broadcast.rf.frequency||868,syncWord:e.broadcast.rf.syncWord||18,spreadingFactor:e.broadcast.rf.spreadingFactor||7,codingRate:e.broadcast.rf.codingRate||7,bandwidth:e.broadcast.rf.bandwidth||250,txPower:e.broadcast.rf.txPower||22},this._initialized||(this.form.broadcast.syncCode=e.broadcast.rf.syncWord||18,this.form.broadcast.frequency=e.broadcast.rf.frequency||868)):(this.config.broadcast.rf={frequency:868,syncWord:18,spreadingFactor:7,codingRate:7,bandwidth:250,txPower:22},this._initialized||(this.form.broadcast.syncCode=18,this.form.broadcast.frequency=868)),e.led&&!this._initialized&&(e.led.program&&(this.ledColors.program={r:e.led.program.r||255,g:e.led.program.g||0,b:e.led.program.b||0}),e.led.preview&&(this.ledColors.preview={r:e.led.preview.r||0,g:e.led.preview.g||255,b:e.led.preview.b||0}),e.led.off&&(this.ledColors.off={r:e.led.off.r||0,g:e.led.off.g||0,b:e.led.off.b||0})),this._initialized=!0,this.wsConnected=!0}catch(t){console.error("Status fetch error:",t),this.wsConnected=!1}},startStatusPolling(){this.stopStatusPolling();let t=localStorage.getItem("pollingInterval");t&&(this.config.pollingInterval=parseInt(t)),this._statusPollingTimer=setInterval(async()=>{await this.fetchStatus()},this.config.pollingInterval)},stopStatusPolling(){this._statusPollingTimer&&(clearInterval(this._statusPollingTimer),this._statusPollingTimer=null)},setPollingInterval(t){[500,1e3,2e3,5e3].includes(t)||(t=2e3),this.config.pollingInterval=t,localStorage.setItem("pollingInterval",t.toString()),this._statusPollingTimer&&this.startStatusPolling()},async saveBrightness(){try{let t=await fetch("/api/display/brightness",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({brightness:this.form.display.brightness})});if(!t.ok)throw new Error("Failed to save brightness");let e=await t.json();if(e.status==="ok")this.toast("Brightness saved","alert-success");else throw new Error(e.message||"Save failed")}catch(t){console.error("Save brightness error:",t),this.toast(t.message,"alert-error")}},async rebootTx(){if(confirm("Are you sure you want to reboot this device?"))try{if(!(await fetch("/api/reboot",{method:"POST",headers:{"Content-Type":"application/json"}})).ok)throw new Error("Failed to reboot");this.toast("Device is rebooting...","alert-info")}catch(t){console.error("Reboot error:",t),this.toast(t.message,"alert-error")}},async rebootAll(){if(confirm("Are you sure you want to reboot ALL devices?"))try{if(!(await fetch("/api/reboot/broadcast",{method:"POST",headers:{"Content-Type":"application/json"}})).ok)throw new Error("Failed to broadcast reboot");this.toast("Reboot command sent to all devices","alert-info")}catch(t){console.error("Broadcast reboot error:",t),this.toast(t.message,"alert-error")}},globalBrightness:{sending:!1,value:50},notices:{list:[],loading:!1,error:null},noticeModal:{show:!1,notice:null},async setGlobalBrightness(t){let e=parseInt(t,10);if(isNaN(e)||e<0||e>100){console.error("Invalid brightness value:",t);return}let s=Math.round(e*255/100);try{this.globalBrightness.sending=!0;let r=await fetch("/api/brightness/broadcast",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({brightness:s})});if(!r.ok){let a=await r.json().catch(()=>({}));throw new Error(a.message||"Failed to set brightness")}let i=await r.json();if(i.status==="ok")this.globalBrightness.value=e,this.toast(`Broadcast brightness: ${e}%`,"alert-success");else throw new Error(i.message||"Failed to set brightness")}catch(r){console.error("Set global brightness error:",r),this.toast(r.message,"alert-error")}finally{this.globalBrightness.sending=!1}},async fetchNotices(){try{this.notices.loading=!0,this.notices.error=null;let t=await fetch("/api/notices");if(!t.ok)throw new Error("Failed to fetch notices");let e=await t.json();e.success&&e.notices?this.notices.list=e.notices:this.notices.list=[]}catch(t){console.error("Fetch notices error:",t),this.notices.error="Failed to load notices",this.notices.list=[]}finally{this.notices.loading=!1}},formatDate(t){if(!t)return"";let e=new Date(t),s=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0");return`${s}-${r}-${i}`},openNoticeModal(t){this.noticeModal.notice=t,this.noticeModal.show=!0},closeNoticeModal(){this.noticeModal.show=!1}}}function d(){return{async saveAp(){try{let e=await(await fetch("/api/config/network/ap",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ssid:this.form.ap.ssid,password:this.form.ap.password,channel:this.form.ap.channel,enabled:this.form.ap.enabled})})).json();e.status==="ok"?(this.showToast("WiFi AP settings saved - Reconnect if IP changed","alert-success"),await this.fetchStatus()):this.showToast(e.message||"Failed to save WiFi AP settings","alert-error")}catch{this.showToast("Network error. Please try again.","alert-error")}},async saveWifi(){try{let e=await(await fetch("/api/config/network/wifi",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ssid:this.form.wifi.ssid,password:this.form.wifi.password,enabled:this.form.wifi.enabled})})).json();e.status==="ok"?(this.showToast("WiFi STA settings saved - Reconnect if IP changed","alert-success"),await this.fetchStatus()):this.showToast(e.message||"Failed to save WiFi STA settings","alert-error")}catch{this.showToast("Network error. Please try again.","alert-error")}},async saveEthernet(){try{let e=await(await fetch("/api/config/network/ethernet",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dhcp:this.form.ethernet.dhcp,staticIp:this.form.ethernet.ip,gateway:this.form.ethernet.gateway,netmask:this.form.ethernet.netmask,enabled:this.form.ethernet.enabled})})).json();e.status==="ok"?(this.showToast("Ethernet settings saved - Reconnect if IP changed","alert-success"),await this.fetchStatus()):this.showToast(e.message||"Failed to save Ethernet settings","alert-error")}catch{this.showToast("Network error. Please try again.","alert-error")}}}}function f(){return{async savePrimarySwitcher(){try{let t={type:this.form.switcher.primary.type,ip:this.form.switcher.primary.ip,port:this.form.switcher.primary.port,cameraLimit:parseInt(this.form.switcher.primary.cameraLimit)||0};this.form.switcher.primary.type==="ATEM"&&(t.interface=this.form.switcher.primary.interface),this.form.switcher.primary.type==="OBS"&&(t.password=this.form.switcher.primary.password||"");let s=await(await fetch("/api/config/switcher/primary",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();s.status==="ok"?(this.showToast(`Primary switcher saved: ${this.form.switcher.primary.type} @ ${this.form.switcher.primary.ip||"--"}`,"alert-success"),this.showPrimaryConfig=!1,await this.fetchStatus()):this.showToast(s.message||"Failed to save primary switcher","alert-error")}catch{this.showToast("Network error. Please try again.","alert-error")}},async saveSecondarySwitcher(){try{let t={type:this.form.switcher.secondary.type,ip:this.form.switcher.secondary.ip,port:this.form.switcher.secondary.port,cameraLimit:parseInt(this.form.switcher.secondary.cameraLimit)||0};this.form.switcher.secondary.type==="ATEM"&&(t.interface=this.form.switcher.secondary.interface),this.form.switcher.secondary.type==="OBS"&&(t.password=this.form.switcher.secondary.password||"");let s=await(await fetch("/api/config/switcher/secondary",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();s.status==="ok"?(this.showToast(`Secondary switcher saved: ${this.form.switcher.secondary.type} @ ${this.form.switcher.secondary.ip||"--"}`,"alert-success"),this.showSecondaryConfig=!1,await this.fetchStatus()):this.showToast(s.message||"Failed to save secondary switcher","alert-error")}catch{this.showToast("Network error. Please try again.","alert-error")}},getDefaultPort(t){return{ATEM:9910,vMix:8099,OBS:4455,OSEE:9999}[t]||9910},getSwitcherTypeDisplayName(t){return{ATEM:"ATEM",vMix:"vMix",OBS:"OBS (In Development)",OSEE:"OSEE (In Development)"}[t]||t},getSwitcherTypeDesc(t){return{ATEM:"Blackmagic Design ATEM Switcher",vMix:"vMix Live Video Production Software",OBS:"OBS Studio (In Development)",OSEE:"OSEE (In Development)"}[t]||""},getInterfaceName(t){return{0:"Auto",1:"Ethernet",2:"WiFi"}[t]||"Auto"},onSwitcherTypeChange(t){let e=this.form.switcher[t];e.port=this.getDefaultPort(e.type),e.type!=="ATEM"&&(e.interface=0)},async onDualModeChange(){this.form.switcher.dualEnabled&&(this.form.mappingOffset=this.config.switcher.secondaryOffset||1);try{let e=await(await fetch("/api/config/switcher/dual",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dualEnabled:this.form.switcher.dualEnabled,secondaryOffset:this.form.mappingOffset})})).json();e.status==="ok"?(this.showToast(this.form.switcher.dualEnabled?"Dual mode enabled - Configure secondary start position":"Dual mode disabled","alert-success"),await this.fetchStatus()):(this.showToast(e.message||"Failed to save dual mode","alert-error"),this.form.switcher.dualEnabled=!this.form.switcher.dualEnabled)}catch{this.showToast("Network error. Please try again.","alert-error"),this.form.switcher.dualEnabled=!this.form.switcher.dualEnabled}},getCameraButtonClass(t){let e=this.form.mappingOffset,s=this.status.switcher?.primary,r=this.status.switcher?.secondary,i=this.form.switcher.dualEnabled,a=s?.connected&&s.tally?.channels||0,o=r?.connected&&i&&r.tally?.channels||0;if(!i)return t<=a?"bg-blue-500 text-white cursor-pointer hover:bg-blue-600":"bg-slate-100 text-slate-400 cursor-pointer hover:bg-slate-200";let n=Math.min(a,e-1),c=Math.min(e+o-1,20);return t<=n?"bg-blue-500 text-white cursor-pointer hover:bg-blue-600":t<e?"bg-slate-100 text-slate-400 cursor-pointer hover:bg-slate-200":t===e?o>0?"bg-purple-700 text-white ring-2 ring-purple-400 ring-offset-2 cursor-pointer hover:bg-purple-800":"bg-slate-300 text-slate-600 cursor-pointer hover:bg-slate-400":t<=c?"bg-purple-500 text-white cursor-pointer hover:bg-purple-600":"bg-slate-100 text-slate-400 cursor-pointer hover:bg-slate-200"},getCameraLabel(t){let e=this.form.mappingOffset,s=this.status.switcher?.primary,r=this.status.switcher?.secondary,i=this.form.switcher.dualEnabled,a=s?.connected&&s.tally?.channels||0,o=r?.connected&&i&&r.tally?.channels||0;if(!i)return t<=a?`${t}(P${t})`:`${t}`;let n=Math.min(a,e-1),c=e;if(t<=n)return`${t}(P${t})`;if(t>=c){let l=t-c+1;if(l<=o)return`${t}(S${l})`}return`${t}`},selectOffset(t){this.form.switcher.dualEnabled&&(this.form.mappingOffset=t)},async saveMapping(){try{let e=await(await fetch("/api/config/switcher/dual",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({dualEnabled:this.form.switcher.dualEnabled,secondaryOffset:this.form.mappingOffset})})).json();e.status==="ok"?(this.showToast(`Mapping saved: Secondary starts at camera ${this.form.mappingOffset}`,"alert-success"),await this.fetchStatus()):this.showToast(e.message||"Failed to save mapping","alert-error")}catch{this.showToast("Network error. Please try again.","alert-error")}}}}function p(){return{getChannelPresets(){return{frequencies:this.system?.loraChipType===2?[410,433,450,470,490]:[850,860,868,870,880,900,915,925,930]}},getScanRange(){return this.system?.loraChipType===2?{start:410,end:493,name:"433MHz"}:{start:850,end:930,name:"868MHz"}},channelScan:{scanning:!1,progress:0,step:1,results:[],recommendation:null,currentRssi:0,currentStatus:"unknown"},_channelScanPollingTimer:null,broadcast:{saving:!1},async saveBroadcast(){try{this.broadcast.saving=!0;let e=await(await fetch("/api/config/device/rf",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({frequency:Number(this.form.broadcast.frequency),syncWord:Number(this.form.broadcast.syncCode)})})).json();e.status==="ok"?(await new Promise(s=>setTimeout(s,6e3)),await this.fetchStatus(),this.broadcast.saving=!1,this.showToast(`Channel saved: ${Math.round(this.form.broadcast.frequency)} MHz, Sync 0x${Number(this.form.broadcast.syncCode).toString(16).toUpperCase().padStart(2,"0")}`,"alert-success")):(this.broadcast.saving=!1,this.showToast(e.message||"Failed to save channel settings","alert-error"))}catch{this.broadcast.saving=!1,this.showToast("Network error. Please try again.","alert-error")}},async startChannelScan(){try{this.channelScan.scanning=!0,this.channelScan.progress=0,this.channelScan.results=[],this.channelScan.recommendation=null;let t=this.getScanRange(),s=await(await fetch("/api/lora/scan/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({startFreq:t.start,endFreq:t.end,step:1})})).json();s.status==="ok"?(this.showToast(`Scanning ${t.start}-${t.end} MHz (${t.name})...`,"alert-info"),this.startChannelScanPolling()):(this.channelScan.scanning=!1,this.showToast(s.message||"Failed to start scan","alert-error"))}catch{this.channelScan.scanning=!1,this.showToast("Network error. Please try again.","alert-error")}},async stopChannelScan(){try{await fetch("/api/lora/scan/stop",{method:"POST"}),this.channelScan.scanning=!1,this.stopChannelScanPolling(),this.showToast("Scan cancelled","alert-warning")}catch{this.showToast("Failed to stop scan","alert-error")}},startChannelScanPolling(){this.stopChannelScanPolling(),this._channelScanPollingTimer=setInterval(async()=>{await this.fetchChannelScanStatus()},500)},stopChannelScanPolling(){this._channelScanPollingTimer&&(clearInterval(this._channelScanPollingTimer),this._channelScanPollingTimer=null)},async fetchChannelScanStatus(){try{let t=await fetch("/api/lora/scan");if(!t.ok)return;let e=await t.json();this.channelScan.scanning=e.scanning,this.channelScan.progress=e.progress||0,e.results&&e.results.length>0&&(this.channelScan.results=e.results.map(s=>{let r=Math.max(0,Math.min(100,(-50-s.rssi)/50*100));return{frequency:s.frequency,rssi:s.rssi,noiseFloor:s.noiseFloor,clearChannel:s.clearChannel,gaugePercent:r.toFixed(1)}}),this.analyzeScanRecommendation()),!e.scanning&&e.progress===100&&(this.stopChannelScanPolling(),this.showToast(`Scan complete: ${e.results?.length||0} channels found`,"alert-success"))}catch(t){console.error("Channel scan status fetch error:",t)}},analyzeScanRecommendation(){if(!this.channelScan.results||this.channelScan.results.length===0){this.channelScan.recommendation=null;return}let t=this.form.broadcast.frequency,e=this.channelScan.results.find(i=>Math.abs(i.frequency-t)<.5);e?(this.channelScan.currentRssi=e.rssi,this.channelScan.currentStatus=e.clearChannel?"clear":"busy"):(this.channelScan.currentRssi=0,this.channelScan.currentStatus="unknown");let r=[...this.channelScan.results].sort((i,a)=>i.rssi-a.rssi)[0];e?e.clearChannel||(this.channelScan.recommendation={type:"change",title:"Current channel is noisy",message:"Recommend switching to quieter channel",suggestedFreq:r.frequency}):this.channelScan.recommendation={type:"better",title:"Frequency outside scan range",message:`Consider switching to ${r.frequency.toFixed(1)} MHz`,suggestedFreq:r.frequency}},getGaugeColor(t){return t<=-90?"#22c55e":t<=-80?"#eab308":"#ef4444"},getGaugeCircumference(t){let s=2*Math.PI*16;return`${Math.max(0,Math.min(100,(-50-t)/50*100))/100*s} ${s}`},getGaugeTextColor(t){return t<=-90?"text-emerald-600":t<=-80?"text-yellow-600":"text-rose-600"},selectChannelFrequency(t){this.form.broadcast.frequency=t,this.showToast(`Channel selected: ${Math.round(t)} MHz - Click "Save Channel Settings" to apply`,"alert-info")},scrollToChannelSettings(){let t=document.getElementById("channel-settings");t&&t.scrollIntoView({behavior:"smooth"})}}}function w(){return{devices:{list:[],onlineCount:0,registeredCount:0,loading:!1,_pollingTimer:null},brightnessControl:{sending:null},cameraIdControl:{sending:null},pingControl:{sending:null},statusControl:{sending:!1},stopControl:{sending:null},rebootControl:{sending:null},deleteControl:{sending:null},async initDevices(){await this.fetchDevices(),this.$watch("currentView",t=>{t==="devices"?this.startDevicesPolling():this.stopDevicesPolling()}),this.currentView==="devices"&&this.startDevicesPolling()},async fetchDevices(){try{this.devices.loading=!0;let t=await fetch("/api/devices");if(!t.ok)throw new Error("Failed to fetch devices");let e=await t.json(),s=e.devices||[],r=this.devices.list||[];s.sort((i,a)=>{let o=i.cameraId||999,n=a.cameraId||999;return o-n}),this.devices.list=s.map(i=>{let a=r.find(o=>o.id===i.id);return a&&this.cameraIdControl[i.id]!==void 0&&(i.cameraId=this.cameraIdControl[i.id]),a&&this.brightnessControl[i.id]!==void 0&&(i.brightness=this.brightnessControl[i.id]),i}),this.devices.onlineCount=e.count||0,this.devices.registeredCount=e.registeredCount||0}catch(t){console.error("Devices fetch error:",t),this.devices.list=[],this.devices.onlineCount=0,this.devices.registeredCount=0}finally{this.devices.loading=!1}},startDevicesPolling(){this.devices._pollingTimer||(this.devices._pollingTimer=setInterval(async()=>{await this.fetchDevices()},5e3))},stopDevicesPolling(){this.devices._pollingTimer&&(clearInterval(this.devices._pollingTimer),this.devices._pollingTimer=null)},async setDeviceBrightness(t,e){let s=parseInt(e,10);if(isNaN(s)||s<0||s>100){console.error("Invalid brightness value:",e);return}let r=Math.round(s*255/100);try{this.brightnessControl.sending=t;let i=[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16)],a=await fetch("/api/device/brightness",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceId:i,brightness:r})});if(!a.ok){let n=await a.json().catch(()=>({}));throw new Error(n.message||"Failed to set brightness")}let o=await a.json();if(o.status==="ok"){console.log(`Brightness set for ${t}: ${s}% (${r})`);let n=this.devices.list.find(c=>c.id===t);n&&(n.brightness=s),delete this.brightnessControl[t]}else throw new Error(o.message||"Failed to set brightness")}catch(i){console.error("Set brightness error:",i),alert(i.message)}finally{this.brightnessControl.sending=null}},async setDeviceCameraId(t,e){let s=parseInt(e,10);if(isNaN(s)||s<1||s>20){console.error("Invalid camera ID:",e);return}try{this.cameraIdControl.sending=t;let r=[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16)],i=await fetch("/api/device/camera-id",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceId:r,cameraId:s})});if(!i.ok){let o=await i.json().catch(()=>({}));throw new Error(o.message||"Failed to set camera ID")}let a=await i.json();if(a.status==="ok"){console.log(`Camera ID set for ${t}: ${s}`);let o=this.devices.list.find(n=>n.id===t);o&&(o.cameraId=s),delete this.cameraIdControl[t]}else throw new Error(a.message||"Failed to set camera ID")}catch(r){console.error("Set camera ID error:",r),alert(r.message)}finally{this.cameraIdControl.sending=null}},adjustCameraId(t,e){let r=(this.cameraIdControl[t]??this.devices.list.find(i=>i.id===t)?.cameraId??1)+e;r>=1&&r<=20&&(this.cameraIdControl[t]=r,this.setDeviceCameraId(t,r))},async pingDevice(t){try{this.pingControl.sending=t;let e=[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16)],s=await fetch("/api/device/ping",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceId:e})});if(!s.ok){let i=await s.json().catch(()=>({}));throw new Error(i.message||"Failed to send ping")}let r=await s.json();if(r.status==="ok")console.log(`PING sent to ${t}`);else throw new Error(r.message||"Failed to send ping")}catch(e){console.error("PING error:",e),alert(e.message)}finally{this.pingControl.sending=null}},async requestStatus(){try{this.statusControl.sending=!0;let t=await fetch("/api/device/status-request",{method:"POST",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to send status request");let e=await t.json();if(e.status==="ok")console.log("Status request sent");else throw new Error(e.message||"Failed to send status request")}catch(t){console.error("Status request error:",t),alert(t.message)}finally{this.statusControl.sending=!1}},async stopDevice(t){try{this.stopControl.sending=t;let e=[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16)],s=await fetch("/api/device/stop",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceId:e})});if(!s.ok)throw new Error("Failed to send stop command");let r=await s.json();if(r.status==="ok")console.log(`Stop command sent to ${t}`),setTimeout(()=>this.fetchDevices(),500);else throw new Error(r.message||"Failed to send stop command")}catch(e){console.error("Stop command error:",e),alert(e.message)}finally{this.stopControl.sending=null}},async rebootDevice(t){try{if(!confirm(`Reboot device ${t}?`))return;this.rebootControl.sending=t;let e=[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16)],s=await fetch("/api/device/reboot",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceId:e})});if(!s.ok)throw new Error("Failed to send reboot command");let r=await s.json();if(r.status==="ok")console.log(`Reboot command sent to ${t}`),alert(`Reboot command sent to device ${t}`);else throw new Error(r.message||"Failed to send reboot command")}catch(e){console.error("Reboot command error:",e),e.message!=="User canceled"&&alert(e.message)}finally{this.rebootControl.sending=null}},async deleteDevice(t){try{if(!confirm(`Delete device ${t}?

This will remove the device from the list and clear its camera ID mapping.`))return;this.deleteControl.sending=t;let e=[parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16)],s=await fetch("/api/devices",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceId:e})});if(!s.ok)throw new Error("Failed to delete device");let r=await s.json();if(r.status==="ok")console.log(`Device deleted: ${t}`),this.devices.list=this.devices.list.filter(i=>i.id!==t),alert(`Device ${t} deleted successfully.`);else throw new Error(r.message||"Failed to delete device")}catch(e){console.error("Delete device error:",e),e.message!=="User canceled"&&alert(e.message)}finally{this.deleteControl.sending=null}},formatUptime(t){if(!t)return"0s";let e=Math.floor(t/3600),s=Math.floor(t%3600/60),r=t%60;return e>0?`${e}h ${s}m`:s>0?`${s}m ${r}s`:`${r}s`},getSignalLevel(t,e){return!t&&!e?0:t>-70&&e>10?3:t>-85&&e>5?2:1},getSignalText(t,e){let s=this.getSignalLevel(t,e);return s===3?"Good":s===2?"Fair":s===1?"Weak":"--"},async saveLedColors(){this.ledColors.saving=!0;try{(await fetch("/api/led/colors",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({program:{r:Number(this.ledColors.program.r),g:Number(this.ledColors.program.g),b:Number(this.ledColors.program.b)},preview:{r:Number(this.ledColors.preview.r),g:Number(this.ledColors.preview.g),b:Number(this.ledColors.preview.b)},off:{r:Number(this.ledColors.off.r),g:Number(this.ledColors.off.g),b:Number(this.ledColors.off.b)}})})).ok?this.showToast("LED colors saved","alert-success"):this.showToast("Failed to save LED colors","alert-error")}catch{this.showToast("Failed to save LED colors","alert-error")}finally{this.ledColors.saving=!1}},async loadLedColors(){try{let t=await fetch("/api/led/colors");if(t.ok){let e=await t.json();this.ledColors.program=e.program,this.ledColors.preview=e.preview,this.ledColors.off=e.off}}catch(t){console.error("Failed to load LED colors",t)}},rgbToHex(t,e,s){return"#"+[t,e,s].map(r=>{let i=Number(r).toString(16);return i.length===1?"0"+i:i}).join("")},updateLedColor(t,e){let s=parseInt(e.slice(1,3),16),r=parseInt(e.slice(3,5),16),i=parseInt(e.slice(5,7),16);this.ledColors[t].r=s,this.ledColors[t].g=r,this.ledColors[t].b=i},applyLedPreset(t,e,s,r,i,a,o,n,c){this.ledColors.program={r:t,g:e,b:s},this.ledColors.preview={r,g:i,b:a},this.ledColors.off={r:o,g:n,b:c}},isLedPresetActive(t,e,s,r,i,a,o,n,c){return this.ledColors.program.r===t&&this.ledColors.program.g===e&&this.ledColors.program.b===s&&this.ledColors.preview.r===r&&this.ledColors.preview.g===i&&this.ledColors.preview.b===a&&this.ledColors.off.r===o&&this.ledColors.off.g===n&&this.ledColors.off.b===c}}}function m(){return{async saveBrightness(){try{let e=await(await fetch("/api/config/device/brightness",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({value:this.form.display.brightness})})).json();e.status==="ok"?this.showToast(`Brightness saved: ${this.form.display.brightness}`,"alert-success"):this.showToast(e.message||"Failed to save brightness","alert-error")}catch{this.showToast("Network error. Please try again.","alert-error")}},async saveCameraId(){try{let e=await(await fetch("/api/config/device/camera_id",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({value:this.form.display.cameraId})})).json();e.status==="ok"?this.showToast(`Camera ID saved: ${this.form.display.cameraId}`,"alert-success"):this.showToast(e.message||"Failed to save camera ID","alert-error")}catch{this.showToast("Network error. Please try again.","alert-error")}}}}function g(){return{license:{state:1,stateStr:"invalid",isValid:null,deviceLimit:0,key:"",loading:!1},internetTest:{status:"none",serverStatus:"none",ping:0,testing:!1},licenseForm:{key:""},validating:!1,stateNames:{0:"invalid",1:"valid",2:"checking"},async initLicense(){await this.fetchLicense()},async fetchLicense(t=!1){try{let e=await fetch("/api/status");if(!e.ok)throw new Error("Status fetch failed");let r=(await e.json()).license||{};this.license.state=r.state??1,this.license.stateStr=r.stateStr||"invalid",this.license.isValid=r.isValid||!1,this.license.deviceLimit=r.deviceLimit||0,this.license.key=r.key||"",r.key&&r.key.length===16&&(this.licenseForm.key=this.formatLicenseKeyString(r.key)),t&&this.validating&&(this.validating=!1,r.error?this.showToast(r.error,"alert-error"):this.license.isValid?this.showToast("License validated successfully!","alert-success"):this.license.stateStr==="checking"?this.showToast("License validation in progress...","alert-info"):this.license.stateStr==="invalid"&&this.showToast("License validation failed","alert-error"))}catch(e){console.error("License fetch error:",e),this.validating=!1}},formatLicenseKeyString(t){let e=t.replace(/-/g,"").toUpperCase();return e.length>16&&(e=e.slice(0,16)),e.length>12?e=e.slice(0,4)+"-"+e.slice(4,8)+"-"+e.slice(8,12)+"-"+e.slice(12):e.length>8?e=e.slice(0,4)+"-"+e.slice(4,8)+"-"+e.slice(8):e.length>4&&(e=e.slice(0,4)+"-"+e.slice(4)),e},async testInternet(){this.internetTest.testing=!0,this.internetTest.status="testing",this.internetTest.serverStatus="testing",this.internetTest.ping=0;try{let t=await fetch("/api/test/internet",{method:"POST",headers:{"Content-Type":"application/json"}});if(t.ok){let s=await t.json();this.internetTest.status=s.success?"success":"fail",this.internetTest.ping=s.ping||0}else this.internetTest.status="fail";let e=await fetch("/api/test/license-server",{method:"POST",headers:{"Content-Type":"application/json"}});if(e.ok){let s=await e.json();if(this.internetTest.serverStatus=s.success?"success":"fail",s.success)this.showToast("License server connection successful","alert-success");else{let r=s.error||"License server connection failed";this.showToast(r,"alert-error")}}else this.internetTest.serverStatus="fail",this.showToast("License server connection failed","alert-error")}catch(t){console.error("Internet test error:",t),this.internetTest.status="fail",this.internetTest.serverStatus="fail",this.showToast("Connection test failed: "+t.message,"alert-error")}finally{this.internetTest.testing=!1}},formatLicenseKey(t){let e=t.target.value.toUpperCase();e=e.replace(/-/g,""),e=e.replace(/[^A-Z0-9]/g,""),e.length>16&&(e=e.slice(0,16)),e.length>12?e=e.slice(0,4)+"-"+e.slice(4,8)+"-"+e.slice(8,12)+"-"+e.slice(12):e.length>8?e=e.slice(0,4)+"-"+e.slice(4,8)+"-"+e.slice(8):e.length>4&&(e=e.slice(0,4)+"-"+e.slice(4)),this.licenseForm.key=e},async validateLicense(){let t=this.licenseForm.key.trim();if(!t){this.showToast("Please enter license key","alert-warning");return}let e=t.replace(/-/g,"");if(e.length!==16){this.showToast("License key must be 16 characters (xxxx-xxxx-xxxx-xxxx)","alert-error");return}try{this.license.loading=!0,this.validating=!0;let s=await fetch("/api/license/validate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({key:e})});if(!s.ok)throw new Error("Validation request failed");let r=await s.json();r.status==="accepted"?(this.showToast("License validation started. Please wait...","alert-info"),this.licenseForm.key="",setTimeout(()=>this.fetchLicense(!0),3e3)):this.showToast("Validation failed: "+(r.error||"Unknown error"),"alert-error")}catch(s){console.error("License validate error:",s),this.showToast("Validation request failed","alert-error")}finally{this.license.loading=!1}},getLicenseStatusText(){return this.license.isValid?`Active (${this.license.deviceLimit})`:{invalid:"Inactive",trial:"Trial",checking:"Checking",none:"Not Registered"}[this.license.stateStr]||this.license.stateStr.toUpperCase()},getLicenseStatusClass(){return this.license.isValid?"text-emerald-600 bg-emerald-50":this.license.stateStr==="trial"||this.license.stateStr==="checking"?"text-blue-600 bg-blue-50":"text-rose-600 bg-rose-50"},getLicenseIndicatorClass(){return this.license.isValid?"bg-emerald-500":this.license.stateStr==="trial"||this.license.stateStr==="checking"?"bg-blue-500":"bg-rose-500"},maskLicenseKey(t){if(!t||t.length===0)return"Not registered";if(t.includes("-")){let e=t.split("-");if(e.length===4)return`${e[0]}-****-****-****`}return t.length>=4?t.substring(0,4)+"-****-****-****":t}}}function u(){return{testMode:{running:!1,maxChannels:4,interval:500},async startTestMode(){try{let t=await fetch("/api/test/start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({max_channels:Number(this.testMode.maxChannels),interval_ms:Number(this.testMode.interval)})});if(t.ok)this.testMode.running=!0,this.showToast("Test mode started","alert-info");else{let e=await t.json();this.showToast(e.message||"Failed to start test mode","alert-error")}}catch{this.showToast("Failed to start test mode","alert-error")}},async stopTestMode(){try{(await fetch("/api/test/stop",{method:"POST"})).ok?(this.testMode.running=!1,this.showToast("Test mode stopped","alert-info")):this.showToast("Failed to stop test mode","alert-error")}catch{this.showToast("Failed to stop test mode","alert-error")}}}}function y(){return{showPrimaryConfig:!1,showSecondaryConfig:!1,showFactoryResetModal:!1,factoryResetting:!1,toastState:{show:!1,message:"",type:"alert-info"},showToast(t,e="alert-info"){this.toastState.message=t,this.toastState.type=e,this.toastState.show=!0,setTimeout(()=>{this.toastState.show=!1},3e3)},toast(t,e="alert-info"){this.toastState.message=t,this.toastState.type=e,this.toastState.show=!0,setTimeout(()=>{this.toastState.show=!1},3e3)},formatUptimeShort(t){let e=Math.floor(t/3600),s=Math.floor(t%3600/60),r=t%60,i=String(e).padStart(2,"0"),a=String(s).padStart(2,"0"),o=String(r).padStart(2,"0");return`${i}:${a}:${o}`},formatUptime(t){let e=Math.floor(t/3600),s=Math.floor(t%3600/60);return e>0?`${e}h ${s}m`:`${s}m`},getSignalLevel(t,e){return t>-70&&e>5?3:t>-85&&e>0?2:t>-100&&e>-5?1:0},getSignalText(t,e){let s=this.getSignalLevel(t,e);return s===3?"Strong":s===2?"Good":s===1?"Weak":"No Signal"},formatBytes(t){return t<1024?t+" B":t<1024*1024?(t/1024).toFixed(1)+" KB":(t/(1024*1024)).toFixed(1)+" MB"},goTo(t){this.currentView=t},async reboot(){if(confirm("Are you sure you want to reboot the device?"))try{await fetch("/api/reboot",{method:"POST"}),this.showToast("Rebooting device...","alert-info")}catch{this.showToast("Failed to reboot","alert-error")}},async factoryReset(){this.factoryResetting=!0;try{let e=await(await fetch("/api/factory-reset",{method:"POST"})).json();e.status==="ok"?(this.showFactoryResetModal=!1,this.showToast("Factory reset in progress... System will reboot.","alert-info"),setTimeout(()=>{window.location.reload()},3e3)):this.showToast("Factory reset failed: "+(e.message||"Unknown error"),"alert-error")}catch(t){this.showToast("Factory reset failed: "+t.message,"alert-error")}finally{this.factoryResetting=!1}}}}function b(){return{sidebarOpen:!1,...h(),...d(),...f(),...p(),...w(),...m(),...g(),...u(),...y()}}document.addEventListener("alpine:init",()=>{Alpine.data("tallyApp",b)});})();
