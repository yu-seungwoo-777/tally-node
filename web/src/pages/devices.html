<!-- Devices Page -->
<div x-show="currentView === 'devices'" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0" x-cloak>
    <div class="mb-4">
        <h2 class="text-lg md:text-xl font-semibold text-slate-900">Connected Devices</h2>
        <p class="text-xs md:text-sm text-slate-500 hidden sm:block">
            <span x-text="devices.onlineCount"></span> online / <span x-text="devices.registeredCount"></span> registered devices
        </p>
    </div>

    <!-- Status bar -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full" :class="devices.onlineCount > 0 ? 'bg-emerald-500' : 'bg-slate-300'"></span>
                    <span class="text-sm text-slate-600"><span class="font-medium" x-text="devices.onlineCount"></span> Online</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-slate-400"></span>
                    <span class="text-sm text-slate-600"><span class="font-medium" x-text="devices.list.filter(d => !d.is_online).length"></span> Offline</span>
                </div>
                <div class="w-px h-4 bg-slate-200"></div>
                <span class="text-xs text-slate-500">Total: <span class="font-medium" x-text="devices.list.length"></span> / <span class="font-medium" x-text="license.deviceLimit"></span> Limit</span>
            </div>
            <div class="flex items-center gap-2">
                <!-- 상태 요청 버튼 -->
                <button @click="requestStatus()"
                        :disabled="statusControl.sending"
                        class="px-3 py-1.5 text-sm font-medium text-blue-700 bg-blue-100 hover:bg-blue-200 rounded-lg disabled:bg-blue-50 disabled:text-blue-400 disabled:cursor-not-allowed flex items-center gap-2"
                        title="Request Status (Broadcast)">
                    <svg class="w-4 h-4" :class="{ 'animate-pulse': statusControl.sending }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <span x-text="statusControl.sending ? 'Sending...' : 'Status'"></span>
                </button>
                <!-- Refresh 버튼 -->
                <button @click="fetchDevices()"
                        :disabled="devices.loading"
                        class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg disabled:bg-slate-50 disabled:text-slate-400 disabled:cursor-not-allowed flex items-center gap-2">
                    <svg class="w-4 h-4" :class="{ 'animate-spin': devices.loading }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span x-text="devices.loading ? 'Refreshing...' : 'Refresh'"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- 디바이스 그리드 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="device-grid">
        <template x-for="device in devices.list" :key="device.id">
            <div class="bg-white rounded-2xl border overflow-hidden hover:shadow-lg hover:border-slate-300 transition-all duration-200"
                 :class="{
                     'border-slate-200': device.is_online,
                     'border-slate-200 opacity-60': !device.is_online
                 }">
                <!-- 디바이스 카드 헤더 - 상태 인디케이터 -->
                <div class="relative px-4 py-3"
                     :class="{
                         'bg-gradient-to-r from-slate-50 to-white': device.is_online,
                         'bg-slate-100': !device.is_online
                     }">
                    <!-- 연결 상태 인디케이터 (왼쪽 테두리) -->
                    <div class="absolute left-0 top-0 bottom-0 w-1"
                         :class="{
                             'bg-emerald-500': device.is_online && getSignalLevel(device.rssi, device.snr) === 3,
                             'bg-yellow-500': device.is_online && getSignalLevel(device.rssi, device.snr) === 2,
                             'bg-rose-500': device.is_online && getSignalLevel(device.rssi, device.snr) <= 1,
                             'bg-slate-300': !device.is_online
                         }"></div>

                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <!-- 디바이스 아이콘 -->
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center relative"
                                 :class="{
                                     'bg-emerald-100': device.is_online && getSignalLevel(device.rssi, device.snr) === 3,
                                     'bg-yellow-100': device.is_online && getSignalLevel(device.rssi, device.snr) === 2,
                                     'bg-rose-100': device.is_online && getSignalLevel(device.rssi, device.snr) <= 1,
                                     'bg-slate-200': !device.is_online
                                 }">
                                <svg class="w-5 h-5"
                                     :class="{
                                         'text-emerald-600': device.is_online && getSignalLevel(device.rssi, device.snr) === 3,
                                         'text-yellow-600': device.is_online && getSignalLevel(device.rssi, device.snr) === 2,
                                         'text-rose-600': device.is_online && getSignalLevel(device.rssi, device.snr) <= 1,
                                         'text-slate-400': !device.is_online
                                     }"
                                     fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                                </svg>
                                <!-- 오프라인 배지 -->
                                <div x-show="!device.is_online" x-cloak
                                     class="absolute -top-1 -right-1 w-3 h-3 bg-slate-400 rounded-full border-2 border-white"></div>
                            </div>
                            <div>
                                <p class="font-bold text-slate-900" x-text="device.id"></p>
                                <div class="flex items-center gap-1.5">
                                    <span class="text-xs text-slate-500">Camera</span>
                                    <span class="px-1.5 py-0.5 text-xs font-bold rounded-md bg-blue-100 text-blue-700" x-text="device.cameraId"></span>
                                    <!-- 온라인 상태 배지 -->
                                    <span class="px-1.5 py-0.5 text-xs font-medium rounded-md"
                                          :class="{
                                              'bg-emerald-100 text-emerald-700': device.is_online,
                                              'bg-slate-200 text-slate-500': !device.is_online
                                          }"
                                          x-text="device.is_online ? 'Online' : 'Offline'"></span>
                                </div>
                            </div>
                        </div>
                        <!-- Ping 수치 + 버튼 -->
                        <div class="text-right">
                            <template x-if="device.is_online">
                                <div class="flex items-center gap-2">
                                    <p class="text-xs font-medium" :class="{
                                        'text-emerald-600': device.ping < 200,
                                        'text-yellow-600': device.ping >= 200 && device.ping < 500,
                                        'text-rose-600': device.ping >= 500
                                    }" x-text="device.ping + ' ms'"></p>
                                    <button @click="pingDevice(device.id)"
                                            :disabled="pingControl.sending === device.id"
                                            class="p-1 rounded hover:bg-slate-100 disabled:opacity-50"
                                            :title="'PING ' + device.id">
                                        <svg class="w-3.5 h-3.5 text-slate-500" :class="{
                                            'animate-spin': pingControl.sending === device.id
                                        }" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </button>
                                </div>
                            </template>
                            <template x-if="!device.is_online">
                                <p class="text-xs font-medium text-slate-400">--</p>
                            </template>
                            <p class="text-xs text-slate-400">Latency</p>
                        </div>
                    </div>
                </div>

                <!-- 디바이스 카드 내용 -->
                <div class="p-4 space-y-4">
                    <!-- 배터리 - 크게 강조 -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-1.5">
                                <svg class="w-4 h-4" :class="{
                                    'text-emerald-500': device.battery > 50,
                                    'text-yellow-500': device.battery > 20 && device.battery <= 50,
                                    'text-rose-500': device.battery <= 20
                                }" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="2" y="6" width="16" height="12" rx="2" />
                                    <path d="M22 14v-4" />
                                </svg>
                                <span class="text-xs font-medium text-slate-600">Battery</span>
                            </div>
                            <span class="text-sm font-bold" :class="{
                                'text-emerald-600': device.battery > 50,
                                'text-yellow-600': device.battery > 20 && device.battery <= 50,
                                'text-rose-600': device.battery <= 20
                            }" x-text="device.battery + '%'"></span>
                        </div>
                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-500"
                                 :class="{
                                     'bg-gradient-to-r from-emerald-400 to-emerald-600': device.battery > 50,
                                     'bg-gradient-to-r from-yellow-400 to-yellow-600': device.battery > 20 && device.battery <= 50,
                                     'bg-gradient-to-r from-rose-400 to-rose-600': device.battery <= 20
                                 }"
                                 :style="`width: ${device.battery}%`"></div>
                        </div>
                    </div>

                    <!-- 상태 메트릭스 3열 -->
                    <div class="grid grid-cols-3 gap-3">
                        <!-- 주파수 -->
                        <div class="text-center p-2 rounded-xl bg-slate-50">
                            <p class="text-sm font-bold text-slate-700" x-text="device.frequency"></p>
                            <p class="text-xs text-slate-500">MHz</p>
                        </div>

                        <!-- Sync Word -->
                        <div class="text-center p-2 rounded-xl bg-slate-50">
                            <p class="text-sm font-bold text-slate-700" x-text="'0x' + device.syncWord.toString(16).toUpperCase()"></p>
                            <p class="text-xs text-slate-500">Sync</p>
                        </div>

                        <!-- 신호 강도 -->
                        <div class="text-center p-2 rounded-xl bg-slate-50">
                            <p class="text-sm font-bold" :class="{
                                'text-emerald-600': getSignalLevel(device.rssi, device.snr) === 3,
                                'text-yellow-600': getSignalLevel(device.rssi, device.snr) === 2,
                                'text-rose-600': getSignalLevel(device.rssi, device.snr) <= 1
                            }" x-text="getSignalText(device.rssi, device.snr)"></p>
                            <p class="text-xs text-slate-500">Signal</p>
                        </div>
                    </div>

                    <!-- 하단 정보: 업타임 + 밝기 -->
                    <div class="flex items-center justify-between pt-2 border-t border-slate-100">
                        <div class="flex items-center gap-1.5">
                            <svg class="w-3.5 h-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 6v6l4 2"></path>
                            </svg>
                            <span class="text-xs text-slate-500" x-text="formatUptime(device.uptime)"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-3.5 h-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="4"></circle>
                                <path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"></path>
                            </svg>
                            <span class="text-xs font-medium text-slate-600" x-text="device.brightness + '%'"></span>
                        </div>
                    </div>

                    <!-- 밝기 제어 (온라인 디바이스만) -->
                    <div x-show="device.is_online" class="pt-3 border-t border-slate-100">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-medium text-slate-600">Brightness</span>
                            <span class="text-xs font-bold text-slate-700" x-text="(brightnessControl[device.id] ?? device.brightness) + '%'"></span>
                        </div>
                        <input type="range"
                               min="0" max="100"
                               :value="brightnessControl[device.id] || device.brightness"
                               @input="brightnessControl[device.id] = $event.target.value"
                               @change="setDeviceBrightness(device.id, $event.target.value)"
                               :disabled="brightnessControl.sending === device.id"
                               class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-rose-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    </div>

                    <!-- 카메라 ID 제어 (온라인 디바이스만) -->
                    <div x-show="device.is_online" class="pt-3 border-t border-slate-100">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-medium text-slate-600">Camera ID</span>
                            <span class="text-xs font-bold text-slate-700" x-text="cameraIdControl[device.id] ?? device.cameraId"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button @click="adjustCameraId(device.id, -1)"
                                    :disabled="cameraIdControl.sending === device.id"
                                    class="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-100 hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed text-slate-600 font-bold">
                                -
                            </button>
                            <input type="number"
                                   min="1" max="20"
                                   :value="cameraIdControl[device.id] || device.cameraId"
                                   @change="setDeviceCameraId(device.id, $event.target.value)"
                                   :disabled="cameraIdControl.sending === device.id"
                                   class="flex-1 text-center text-sm font-medium border border-slate-200 rounded-lg px-2 py-1.5 disabled:opacity-50">
                            <button @click="adjustCameraId(device.id, 1)"
                                    :disabled="cameraIdControl.sending === device.id"
                                    class="w-8 h-8 flex items-center justify-center rounded-lg bg-slate-100 hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed text-slate-600 font-bold">
                                +
                            </button>
                        </div>
                    </div>

                    <!-- 기능 제어 버튼 (온라인/오프라인 모두) -->
                    <div class="pt-3 border-t border-slate-100">
                        <div class="flex items-center gap-2">
                            <!-- 기능 정지 버튼 -->
                            <button @click="stopDevice(device.id)"
                                    :disabled="stopControl.sending === device.id"
                                    class="flex-1 px-3 py-2 text-xs font-medium rounded-lg border disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-1.5"
                                    :class="{
                                        'bg-amber-50 text-amber-700 border-amber-200 hover:bg-amber-100': !device.is_stopped,
                                        'bg-green-50 text-green-700 border-green-200 hover:bg-green-100': device.is_stopped
                                    }"
                                    :title="device.is_stopped ? 'Resume' : 'Stop'">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path x-show="!device.is_stopped" stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    <path x-show="device.is_stopped" stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                    <path x-show="device.is_stopped" stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span x-text="device.is_stopped ? 'Resume' : 'Stop'"></span>
                            </button>
                            <!-- 재부팅 버튼 -->
                            <button @click="rebootDevice(device.id)"
                                    :disabled="rebootControl.sending === device.id"
                                    class="flex-1 px-3 py-2 text-xs font-medium text-rose-700 bg-rose-50 border border-rose-200 hover:bg-rose-100 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-1.5"
                                    title="Reboot">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <span>Reboot</span>
                            </button>
                            <!-- 삭제 버튼 -->
                            <button @click="deleteDevice(device.id)"
                                    :disabled="deleteControl.sending === device.id"
                                    class="px-3 py-2 text-xs font-medium text-slate-700 bg-slate-100 border border-slate-200 hover:bg-slate-200 hover:text-red-600 hover:border-red-200 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-1.5"
                                    title="Delete">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                <span class="hidden sm:inline">Delete</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- 디바이스 없음 -->
    <div x-show="devices.list.length === 0 && !devices.loading"
         class="text-center py-16 bg-white rounded-xl border border-slate-200">
        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
            </svg>
        </div>
        <p class="text-slate-600 font-medium">No devices connected</p>
        <p class="text-sm text-slate-400 mt-1">Devices will appear here when they come online</p>
    </div>
</div>
