name: üîí Security Secrets Detection

# Trigger on every push and PR to catch secrets early
on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  secrets-detection:
    name: üîê Detect API Keys & Secrets
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: üîë Run TruffleHog Secret Scanner
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: üîç Custom Pattern Detection
        run: |
          echo "üîç Running custom secret pattern detection..."

          # Define patterns to search for
          PATTERNS=(
              "AIzaSy[A-Za-z0-9_-]{35}"           # Google APIs
              "sk-[A-Za-z0-9]{20,}"                # OpenAI
              "sk_[A-Za-z0-9]{20,}"                # OpenAI variant
              "sk-ant-[A-Za-z0-9]{20,}"           # Anthropic
              "AKIA[0-9A-Z]{16}"                   # AWS Access Keys
              "aws_secret_access_key.*=.*[A-Za-z0-9/+]{40}"
              "access[_-]?token.*=.*[A-Za-z0-9._-]{20,}"
          )

          # Excluded directories
          EXCLUDE_DIRS="node_modules|venv|.venv|.git|.next|dist|build"

          FOUND_SECRETS=false

          for PATTERN in "${PATTERNS[@]}"; do
              echo "Checking pattern: $PATTERN"

              MATCHES=$(find . \
                  -type f \
                  -not -path "*/.*" \
                  -not -path "*/$EXCLUDE_DIRS/*" \
                  -exec grep -l "$PATTERN" {} \; 2>/dev/null || true)

              if [ ! -z "$MATCHES" ]; then
                  echo "‚ùå Found potential secrets in:"
                  echo "$MATCHES"
                  FOUND_SECRETS=true
              fi
          done

          if [ "$FOUND_SECRETS" = true ]; then
              echo ""
              echo "‚ö†Ô∏è  Potential secrets detected! Please review before committing."
              exit 1
          else
              echo "‚úÖ No obvious secrets detected"
          fi

      - name: üìã Check .env and secrets/ directories
        run: |
          echo "üìã Checking for .env files in staging area..."

          # Get list of files that would be committed
          FILES=$(git diff --cached --name-only 2>/dev/null || true)

          # Check for .env files and secrets directory
          if echo "$FILES" | grep -q -E '\.env|secrets/|\.key|\.pem'; then
              echo "‚ùå ERROR: Attempting to commit sensitive files!"
              echo ""
              echo "Files detected:"
              echo "$FILES" | grep -E '\.env|secrets/|\.key|\.pem'
              echo ""
              echo "These files should NOT be committed:"
              echo "  - .env files (API keys, tokens)"
              echo "  - secrets/ directory (credentials)"
              echo "  - .key, .pem files (certificates)"
              echo ""
              echo "Add them to .gitignore instead:"
              echo "  echo '.env' >> .gitignore"
              exit 1
          fi

          echo "‚úÖ No sensitive files detected in commit"

      - name: üõ°Ô∏è Validate .gitignore completeness
        run: |
          echo "üõ°Ô∏è Verifying .gitignore has all sensitive patterns..."

          REQUIRED_PATTERNS=(
              ".env"
              "*.key"
              "*.pem"
              "secrets/"
              "credentials/"
          )

          GITIGNORE_FILE=".gitignore"

          if [ ! -f "$GITIGNORE_FILE" ]; then
              echo "‚ùå .gitignore file not found!"
              exit 1
          fi

          MISSING_PATTERNS=()

          for PATTERN in "${REQUIRED_PATTERNS[@]}"; do
              if ! grep -q "$PATTERN" "$GITIGNORE_FILE"; then
                  MISSING_PATTERNS+=("$PATTERN")
              fi
          done

          if [ ${#MISSING_PATTERNS[@]} -gt 0 ]; then
              echo "‚ö†Ô∏è  Missing patterns in .gitignore:"
              for PATTERN in "${MISSING_PATTERNS[@]}"; do
                  echo "  - $PATTERN"
              done
              echo ""
              echo "Please add these patterns to .gitignore"
              exit 1
          fi

          echo "‚úÖ .gitignore is properly configured"

      - name: üìù Comment on PR if secrets found
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå **Security Check Failed: Potential Secrets Detected**

              This PR contains patterns that match known API keys, tokens, or credentials.

              üîí **Security Requirements:**
              - Never commit API keys, tokens, or passwords
              - Use \`.env\` files (git-ignored) for local configuration
              - Use GitHub Secrets for CI/CD sensitive data
              - Use environment variables in production deployments

              ‚úÖ **How to fix:**
              1. Remove real secrets from files
              2. Replace with placeholders like: \`your_actual_key_here\`
              3. Store real values in \`.env\` (add to .gitignore)
              4. Force push corrected commits: \`git push --force-with-lease\`

              üìö **Reference:** https://github.com/modu-ai/moai-adk/security
              `
            })

      - name: ‚úÖ Summary
        if: success()
        run: |
          echo "üéâ All security checks passed!"
          echo ""
          echo "‚úÖ Secrets detection complete"
          echo "‚úÖ .env files are properly ignored"
          echo "‚úÖ .gitignore is properly configured"
