name: Continuous Integration

# Universal CI/CD pipeline for MoAI-ADK projects
# Auto-detects: Python, Node.js, Go, Rust, Java, Ruby, Elixir, Kotlin, Scala, Swift, C#, C++, Flutter, R
# Triggers: Pull requests and pushes to main/develop branches

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [develop, main]

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-language:
    name: Detect Project Language
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.detect.outputs.python }}
      node: ${{ steps.detect.outputs.node }}
      go: ${{ steps.detect.outputs.go }}
      rust: ${{ steps.detect.outputs.rust }}
      java: ${{ steps.detect.outputs.java }}
      ruby: ${{ steps.detect.outputs.ruby }}
      elixir: ${{ steps.detect.outputs.elixir }}
      kotlin: ${{ steps.detect.outputs.kotlin }}
      scala: ${{ steps.detect.outputs.scala }}
      swift: ${{ steps.detect.outputs.swift }}
      csharp: ${{ steps.detect.outputs.csharp }}
      cpp: ${{ steps.detect.outputs.cpp }}
      flutter: ${{ steps.detect.outputs.flutter }}
      r: ${{ steps.detect.outputs.r }}
      primary_language: ${{ steps.detect.outputs.primary_language }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Auto-detect language
        id: detect
        run: |
          echo "Auto-detecting project language..."
          echo ""

          # Python detection
          if [ -f "pyproject.toml" ] || [ -f "setup.py" ] || [ -f "requirements.txt" ]; then
            echo "Python project detected"
            echo "python=true" >> $GITHUB_OUTPUT
            PRIMARY="python"
          else
            echo "python=false" >> $GITHUB_OUTPUT
          fi

          # Node.js detection
          if [ -f "package.json" ]; then
            echo "Node.js project detected"
            echo "node=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="node"
          else
            echo "node=false" >> $GITHUB_OUTPUT
          fi

          # Go detection
          if [ -f "go.mod" ]; then
            echo "Go project detected"
            echo "go=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="go"
          else
            echo "go=false" >> $GITHUB_OUTPUT
          fi

          # Rust detection
          if [ -f "Cargo.toml" ]; then
            echo "Rust project detected"
            echo "rust=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="rust"
          else
            echo "rust=false" >> $GITHUB_OUTPUT
          fi

          # Java detection
          if [ -f "pom.xml" ] || [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            echo "Java project detected"
            echo "java=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="java"
          else
            echo "java=false" >> $GITHUB_OUTPUT
          fi

          # Ruby detection
          if [ -f "Gemfile" ]; then
            echo "Ruby project detected"
            echo "ruby=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="ruby"
          else
            echo "ruby=false" >> $GITHUB_OUTPUT
          fi

          # Elixir detection
          if [ -f "mix.exs" ]; then
            echo "Elixir project detected"
            echo "elixir=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="elixir"
          else
            echo "elixir=false" >> $GITHUB_OUTPUT
          fi

          # Kotlin detection (separate from Java)
          if [ -f "build.gradle.kts" ] && grep -q "kotlin(" build.gradle.kts 2>/dev/null; then
            echo "Kotlin project detected"
            echo "kotlin=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="kotlin"
          else
            echo "kotlin=false" >> $GITHUB_OUTPUT
          fi

          # Scala detection
          if [ -f "build.sbt" ]; then
            echo "Scala project detected"
            echo "scala=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="scala"
          else
            echo "scala=false" >> $GITHUB_OUTPUT
          fi

          # Swift detection
          if [ -f "Package.swift" ] || [ -f "Package.resolved" ]; then
            echo "Swift project detected"
            echo "swift=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="swift"
          else
            echo "swift=false" >> $GITHUB_OUTPUT
          fi

          # C# detection
          if find . -name "*.csproj" -o -name "*.sln" | grep -q .; then
            echo "C# project detected"
            echo "csharp=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="csharp"
          else
            echo "csharp=false" >> $GITHUB_OUTPUT
          fi

          # C++ detection
          if [ -f "CMakeLists.txt" ] || [ -f "Makefile" ] || [ -f "meson.build" ]; then
            echo "C++ project detected"
            echo "cpp=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="cpp"
          else
            echo "cpp=false" >> $GITHUB_OUTPUT
          fi

          # Flutter detection
          if [ -f "pubspec.yaml" ] && grep -q "flutter" pubspec.yaml 2>/dev/null; then
            echo "Flutter project detected"
            echo "flutter=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="flutter"
          else
            echo "flutter=false" >> $GITHUB_OUTPUT
          fi

          # R detection
          if [ -f "DESCRIPTION" ] || [ -f "renv.lock" ]; then
            echo "R project detected"
            echo "r=true" >> $GITHUB_OUTPUT
            [ -z "$PRIMARY" ] && PRIMARY="r"
          else
            echo "r=false" >> $GITHUB_OUTPUT
          fi

          # Set primary language
          if [ -z "$PRIMARY" ]; then
            echo "No language detected, defaulting to generic checks"
            PRIMARY="generic"
          fi

          echo ""
          echo "Primary language: $PRIMARY"
          echo "primary_language=$PRIMARY" >> $GITHUB_OUTPUT

  code-quality-python:
    name: Python Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.python == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          echo "Installing Python dependencies..."

          if [ -f "pyproject.toml" ]; then
            pip install -e .[dev] || pip install -e . || true
          elif [ -f "setup.py" ]; then
            pip install -e . || true
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt || true
          fi

          pip install black ruff mypy bandit || true

      - name: Check code formatting (black)
        run: |
          echo "Checking Python code formatting..."
          black --check . --line-length=120 || echo "Formatting issues found (non-blocking)"

      - name: Lint code (ruff)
        run: |
          echo "Linting Python code..."
          ruff check . || echo "Linting issues found (non-blocking)"

      - name: Type checking (mypy)
        run: |
          echo "Type checking Python code..."
          mypy . --ignore-missing-imports || echo "Type issues found (non-blocking)"

      - name: Security check (bandit)
        run: |
          echo "Security scanning Python code..."
          bandit -r . -ll || echo "Security issues found (non-blocking)"

  code-quality-node:
    name: Node.js Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.node == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          echo "Installing Node.js dependencies..."
          npm ci || npm install || true

      - name: Lint code (ESLint)
        run: |
          echo "Linting JavaScript/TypeScript code..."
          npm run lint || npx eslint . || echo "Linting issues found (non-blocking)"

      - name: Check formatting (Prettier)
        run: |
          echo "Checking code formatting..."
          npm run format:check || npx prettier --check . || echo "Formatting issues found (non-blocking)"

      - name: Type checking (TypeScript)
        run: |
          echo "Type checking TypeScript..."
          npm run type-check || npx tsc --noEmit || echo "Type issues found (non-blocking)"

  code-quality-go:
    name: Go Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.go == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Format check (gofmt)
        run: |
          echo "Checking Go code formatting..."
          gofmt -l . | grep . && echo "Formatting issues found" || echo "Format check passed"

      - name: Lint code (golangci-lint)
        run: |
          echo "Linting Go code..."
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          golangci-lint run || echo "Linting issues found (non-blocking)"

      - name: Vet code
        run: |
          echo "Running go vet..."
          go vet ./... || echo "Vet issues found (non-blocking)"

  code-quality-rust:
    name: Rust Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.rust == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Format check (rustfmt)
        run: |
          echo "Checking Rust code formatting..."
          cargo fmt --check || echo "Formatting issues found (non-blocking)"

      - name: Lint code (clippy)
        run: |
          echo "Linting Rust code..."
          cargo clippy -- -D warnings || echo "Clippy warnings found (non-blocking)"

  code-quality-java:
    name: Java Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.java == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Checkstyle
        run: |
          echo "Running Java code quality checks..."

          if [ -f "pom.xml" ]; then
            mvn checkstyle:check || echo "Checkstyle issues found (non-blocking)"
          elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            ./gradlew checkstyleMain || echo "Checkstyle issues found (non-blocking)"
          fi

  code-quality-ruby:
    name: Ruby Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.ruby == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install dependencies
        run: |
          echo "Installing Ruby dependencies..."
          bundle install || true

      - name: RuboCop
        run: |
          echo "Running RuboCop..."
          bundle exec rubocop || echo "RuboCop issues found (non-blocking)"

  code-quality-elixir:
    name: Elixir Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.elixir == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.15'
          otp-version: '26'

      - name: Install dependencies
        run: |
          echo "Installing Elixir dependencies..."
          mix deps.get || true
          mix format --check-formatted || echo "Formatting issues found (non-blocking)"

      - name: Credo
        run: |
          echo "Running Credo..."
          mix credo || echo "Credo issues found (non-blocking)"

  code-quality-kotlin:
    name: Kotlin Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.kotlin == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Detekt
        run: |
          echo "Running Detekt..."
          ./gradlew detekt || echo "Detekt issues found (non-blocking)"

      - name: Format check
        run: |
          echo "Checking Kotlin formatting..."
          ./gradlew ktlintCheck || echo "Formatting issues found (non-blocking)"

  code-quality-scala:
    name: Scala Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.scala == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Scala
        uses: olafurpg/setup-scala@v14
        with:
          java-version: 'adopt@1.17'

      - name: Scalafmt
        run: |
          echo "Checking Scala formatting..."
          sbt scalafmtCheckAll || echo "Formatting issues found (non-blocking)"

      - name: Scalastyle
        run: |
          echo "Running Scalastyle..."
          sbt scalastyle || echo "Scalastyle issues found (non-blocking)"

  code-quality-swift:
    name: Swift Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.swift == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift/setup-swift@v1
        with:
          swift-version: '5.9'

      - name: Format check (swift-format)
        run: |
          echo "Checking Swift formatting..."
          swift-format lint . || echo "Formatting issues found (non-blocking)"

      - name: SwiftLint
        run: |
          echo "Running SwiftLint..."
          swiftlint lint || echo "SwiftLint issues found (non-blocking)"

  code-quality-csharp:
    name: C# Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.csharp == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0'

      - name: Restore dependencies
        run: |
          echo "Restoring .NET dependencies..."
          dotnet restore || true

      - name: Format check
        run: |
          echo "Checking C# formatting..."
          dotnet format --verify-no-changes || echo "Formatting issues found (non-blocking)"

      - name: Analyze
        run: |
          echo "Running .NET analyzers..."
          dotnet build || echo "Build issues found (non-blocking)"

  code-quality-cpp:
    name: C++ Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.cpp == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup C++
        uses: clang/setup-linter@v1

      - name: Clang-format
        run: |
          echo "Checking C++ formatting..."
          find . -name '*.cpp' -o -name '*.h' -o -name '*.cc' | xargs clang-format --dry-run -Werror || echo "Formatting issues found (non-blocking)"

      - name: Clang-tidy
        run: |
          echo "Running Clang-tidy..."
          if [ -f "CMakeLists.txt" ]; then
            cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=ON .
            find . -name '*.cpp' | xargs clang-tidy || echo "Tidy issues found (non-blocking)"
          fi

  code-quality-flutter:
    name: Flutter Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.flutter == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16'
          channel: 'stable'

      - name: Install dependencies
        run: |
          echo "Installing Flutter dependencies..."
          flutter pub get || true

      - name: Analyze
        run: |
          echo "Analyzing Flutter code..."
          flutter analyze || echo "Analysis issues found (non-blocking)"

      - name: Format check
        run: |
          echo "Checking Flutter formatting..."
          dart format --output=none --set-exit-if-changed . || echo "Formatting issues found (non-blocking)"

  code-quality-r:
    name: R Code Quality
    runs-on: ubuntu-latest
    needs: detect-language
    if: needs.detect-language.outputs.r == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3'

      - name: Install dependencies
        run: |
          echo "Installing R dependencies..."
          Rscript -e "install.packages('lintr')" || true
          Rscript -e "install.packages('styler')" || true

      - name: Lintr
        run: |
          echo "Running Lintr..."
          Rscript -e "lintr::lint_dir()" || echo "Linting issues found (non-blocking)"

      - name: Style check
        run: |
          echo "Checking R formatting..."
          Rscript -e "styler::style_dir()" || echo "Formatting issues found (non-blocking)"

  test-python:
    name: Python Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-python]
    if: needs.detect-language.outputs.python == 'true'

    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          echo "Installing dependencies for Python ${{ matrix.python-version }}..."

          if [ -f "pyproject.toml" ]; then
            pip install -e .[dev] || pip install -e . || true
          elif [ -f "setup.py" ]; then
            pip install -e . || true
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt || true
          fi

          pip install pytest pytest-cov || true

      - name: Run tests with coverage
        run: |
          echo "Running Python tests..."
          pytest tests/ --cov --cov-report=xml --cov-report=term -v || echo "Tests failed or not found"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-py${{ matrix.python-version }}
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  test-node:
    name: Node.js Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-node]
    if: needs.detect-language.outputs.node == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Run tests
        run: |
          echo "Running Node.js tests..."
          npm test || echo "Tests failed or not found"

  test-go:
    name: Go Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-go]
    if: needs.detect-language.outputs.go == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run tests
        run: |
          echo "Running Go tests..."
          go test -v ./... -coverprofile=coverage.out || echo "Tests failed or not found"

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.out
          flags: unittests
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  test-rust:
    name: Rust Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-rust]
    if: needs.detect-language.outputs.rust == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Run tests
        run: |
          echo "Running Rust tests..."
          cargo test || echo "Tests failed or not found"

  test-java:
    name: Java Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-java]
    if: needs.detect-language.outputs.java == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run tests
        run: |
          echo "Running Java tests..."

          if [ -f "pom.xml" ]; then
            mvn test || echo "Tests failed or not found"
          elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            ./gradlew test || echo "Tests failed or not found"
          fi

  test-ruby:
    name: Ruby Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-ruby]
    if: needs.detect-language.outputs.ruby == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Run tests
        run: |
          echo "Running Ruby tests..."
          bundle exec rake test || bundle exec rspec || echo "Tests failed or not found"

  test-elixir:
    name: Elixir Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-elixir]
    if: needs.detect-language.outputs.elixir == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.15'
          otp-version: '26'

      - name: Install dependencies
        run: mix deps.get || true

      - name: Run tests
        run: |
          echo "Running Elixir tests..."
          mix test || echo "Tests failed or not found"

  test-kotlin:
    name: Kotlin Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-kotlin]
    if: needs.detect-language.outputs.kotlin == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run tests
        run: |
          echo "Running Kotlin tests..."
          ./gradlew test || echo "Tests failed or not found"

  test-scala:
    name: Scala Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-scala]
    if: needs.detect-language.outputs.scala == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Scala
        uses: olafurpg/setup-scala@v14
        with:
          java-version: 'adopt@1.17'

      - name: Run tests
        run: |
          echo "Running Scala tests..."
          sbt test || echo "Tests failed or not found"

  test-swift:
    name: Swift Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-swift]
    if: needs.detect-language.outputs.swift == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift/setup-swift@v1
        with:
          swift-version: '5.9'

      - name: Run tests
        run: |
          echo "Running Swift tests..."
          swift test || echo "Tests failed or not found"

  test-csharp:
    name: C# Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-csharp]
    if: needs.detect-language.outputs.csharp == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0'

      - name: Run tests
        run: |
          echo "Running C# tests..."
          dotnet test || echo "Tests failed or not found"

  test-cpp:
    name: C++ Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-cpp]
    if: needs.detect-language.outputs.cpp == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup C++
        run: |
          echo "Setting up C++ build environment..."

          if [ -f "CMakeLists.txt" ]; then
            cmake .
            cmake --build .
          elif [ -f "Makefile" ]; then
            make || true
          fi

      - name: Run tests
        run: |
          echo "Running C++ tests..."

          if [ -f "CMakeLists.txt" ]; then
            ctest || echo "Tests failed or not found"
          elif [ -f "Makefile" ]; then
            make test || echo "Tests failed or not found"
          fi

  test-flutter:
    name: Flutter Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-flutter]
    if: needs.detect-language.outputs.flutter == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16'
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get || true

      - name: Run tests
        run: |
          echo "Running Flutter tests..."
          flutter test || echo "Tests failed or not found"

  test-r:
    name: R Tests
    runs-on: ubuntu-latest
    needs: [detect-language, code-quality-r]
    if: needs.detect-language.outputs.r == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3'

      - name: Install dependencies
        run: |
          echo "Installing R dependencies..."
          Rscript -e "install.packages('testthat')" || true

      - name: Run tests
        run: |
          echo "Running R tests..."
          Rscript -e "testthat::test_dir()" || echo "Tests failed or not found"

  build-python:
    name: Build Python Package
    runs-on: ubuntu-latest
    needs: [detect-language, test-python]
    if: needs.detect-language.outputs.python == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: pip install build || true

      - name: Build package
        run: |
          echo "Building Python package..."
          python -m build || echo "Build failed (non-blocking)"

          if [ -d "dist/" ]; then
            echo "Package built successfully"
            ls -lh dist/
          fi

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: dist/
          retention-days: 7

  build-node:
    name: Build Node.js Package
    runs-on: ubuntu-latest
    needs: [detect-language, test-node]
    if: needs.detect-language.outputs.node == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Build package
        run: |
          echo "Building Node.js package..."
          npm run build || echo "Build script not found (non-blocking)"

  build-go:
    name: Build Go Binary
    runs-on: ubuntu-latest
    needs: [detect-language, test-go]
    if: needs.detect-language.outputs.go == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build binary
        run: |
          echo "Building Go binary..."
          go build -v ./... || echo "Build failed (non-blocking)"

  build-rust:
    name: Build Rust Binary
    runs-on: ubuntu-latest
    needs: [detect-language, test-rust]
    if: needs.detect-language.outputs.rust == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Build binary
        run: |
          echo "Building Rust binary..."
          cargo build --release || echo "Build failed (non-blocking)"

  build-java:
    name: Build Java Package
    runs-on: ubuntu-latest
    needs: [detect-language, test-java]
    if: needs.detect-language.outputs.java == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build package
        run: |
          echo "Building Java package..."

          if [ -f "pom.xml" ]; then
            mvn package || echo "Build failed (non-blocking)"
          elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            ./gradlew build || echo "Build failed (non-blocking)"
          fi

  build-ruby:
    name: Build Ruby Gem
    runs-on: ubuntu-latest
    needs: [detect-language, test-ruby]
    if: needs.detect-language.outputs.ruby == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Build gem
        run: |
          echo "Building Ruby gem..."
          gem build *.gemspec || echo "Build failed (non-blocking)"

  build-elixir:
    name: Build Elixir Project
    runs-on: ubuntu-latest
    needs: [detect-language, test-elixir]
    if: needs.detect-language.outputs.elixir == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.15'
          otp-version: '26'

      - name: Build project
        run: |
          echo "Building Elixir project..."
          mix compile || echo "Build failed (non-blocking)"

  build-kotlin:
    name: Build Kotlin Project
    runs-on: ubuntu-latest
    needs: [detect-language, test-kotlin]
    if: needs.detect-language.outputs.kotlin == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build project
        run: |
          echo "Building Kotlin project..."
          ./gradlew build || echo "Build failed (non-blocking)"

  build-scala:
    name: Build Scala Project
    runs-on: ubuntu-latest
    needs: [detect-language, test-scala]
    if: needs.detect-language.outputs.scala == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Scala
        uses: olafurpg/setup-scala@v14
        with:
          java-version: 'adopt@1.17'

      - name: Build project
        run: |
          echo "Building Scala project..."
          sbt compile || echo "Build failed (non-blocking)"

  build-swift:
    name: Build Swift Project
    runs-on: ubuntu-latest
    needs: [detect-language, test-swift]
    if: needs.detect-language.outputs.swift == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift/setup-swift@v1
        with:
          swift-version: '5.9'

      - name: Build project
        run: |
          echo "Building Swift project..."
          swift build || echo "Build failed (non-blocking)"

  build-csharp:
    name: Build C# Project
    runs-on: ubuntu-latest
    needs: [detect-language, test-csharp]
    if: needs.detect-language.outputs.csharp == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0'

      - name: Build project
        run: |
          echo "Building C# project..."
          dotnet build || echo "Build failed (non-blocking)"

  build-cpp:
    name: Build C++ Project
    runs-on: ubuntu-latest
    needs: [detect-language, test-cpp]
    if: needs.detect-language.outputs.cpp == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build project
        run: |
          echo "Building C++ project..."

          if [ -f "CMakeLists.txt" ]; then
            cmake -DCMAKE_BUILD_TYPE=Release .
            cmake --build . || echo "Build failed (non-blocking)"
          elif [ -f "Makefile" ]; then
            make || echo "Build failed (non-blocking)"
          fi

  build-flutter:
    name: Build Flutter Project
    runs-on: ubuntu-latest
    needs: [detect-language, test-flutter]
    if: needs.detect-language.outputs.flutter == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16'
          channel: 'stable'

      - name: Build project
        run: |
          echo "Building Flutter project..."
          flutter build apk --debug || echo "Build failed (non-blocking)"

  build-r:
    name: Build R Package
    runs-on: ubuntu-latest
    needs: [detect-language, test-r]
    if: needs.detect-language.outputs.r == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3'

      - name: Build package
        run: |
          echo "Building R package..."
          R CMD build . || echo "Build failed (non-blocking)"

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [detect-language]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "Quality Gate Results:"
          echo ""
          echo "Primary Language: ${{ needs.detect-language.outputs.primary_language }}"
          echo ""
          echo "CI Pipeline completed"
          echo ""
          echo "Note: This is a universal CI pipeline that adapts to your project."
          echo "Failures in optional steps (linting, formatting) are non-blocking."

      - name: Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY'
          ## Universal CI Pipeline Summary

          | Check | Status |
          |-------|--------|
          | Language Detection | Passed |
          | Code Quality | See individual jobs |
          | Tests | See individual jobs |
          | Build | See individual jobs |

          ### Detected Languages
          - **Python**: ${{ needs.detect-language.outputs.python }}
          - **Node.js**: ${{ needs.detect-language.outputs.node }}
          - **Go**: ${{ needs.detect-language.outputs.go }}
          - **Rust**: ${{ needs.detect-language.outputs.rust }}
          - **Java**: ${{ needs.detect-language.outputs.java }}
          - **Ruby**: ${{ needs.detect-language.outputs.ruby }}
          - **Elixir**: ${{ needs.detect-language.outputs.elixir }}
          - **Kotlin**: ${{ needs.detect-language.outputs.kotlin }}
          - **Scala**: ${{ needs.detect-language.outputs.scala }}
          - **Swift**: ${{ needs.detect-language.outputs.swift }}
          - **C#**: ${{ needs.detect-language.outputs.csharp }}
          - **C++**: ${{ needs.detect-language.outputs.cpp }}
          - **Flutter**: ${{ needs.detect-language.outputs.flutter }}
          - **R**: ${{ needs.detect-language.outputs.r }}

          ### Primary Language
          **${{ needs.detect-language.outputs.primary_language }}**

          ---

          *This is a universal CI pipeline provided by MoAI-ADK*
          SUMMARY
