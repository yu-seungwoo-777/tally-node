#!/bin/bash
# ì»´í¬ë„ŒíŠ¸ ë¦¬ë·° ìŠ¤í¬ë¦½íŠ¸
# ë ˆì´ì–´ë³„ë¡œ Claude CLIë¥¼ ë³‘ë ¬ë¡œ ì‹¤í–‰í•˜ì—¬ ì»´í¬ë„ŒíŠ¸ë¥¼ ë¦¬ë·°í•©ë‹ˆë‹¤.

set -e

# ============================================================================
# ì„¤ì •
# ============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
ARCH_DOC="$PROJECT_DIR/docs/ARCHITECTURE.md"
TMP_DIR="$PROJECT_DIR/docs/tmp"

# ë ˆì´ì–´ ëª©ë¡
LAYERS=(
    "00_common"
    "01_app"
    "02_presentation"
    "03_service"
    "04_driver"
    "05_hal"
)

# ë ˆì´ì–´ë³„ ì„¤ëª…
declare -A LAYER_DESC
LAYER_DESC[00_common]="ê³µí†µ ìœ í‹¸ë¦¬í‹° ë° íƒ€ì… ì •ì˜"
LAYER_DESC[01_app]="ì• í”Œë¦¬ì¼€ì´ì…˜ ê³„ì¸µ"
LAYER_DESC[02_presentation]="í”„ë ˆì  í…Œì´ì…˜ ê³„ì¸µ (ë””ìŠ¤í”Œë ˆì´, ì›¹)"
LAYER_DESC[03_service]="ì„œë¹„ìŠ¤ ê³„ì¸µ (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)"
LAYER_DESC[04_driver]="ë“œë¼ì´ë²„ ê³„ì¸µ (í•˜ë“œì›¨ì–´ ì¶”ìƒí™”)"
LAYER_DESC[05_hal]="HAL ê³„ì¸µ (ì €ìˆ˜ì¤€ í•˜ë“œì›¨ì–´ ì ‘ê·¼)"

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# ============================================================================
# ë„ìš°ë¯¸ í•¨ìˆ˜
# ============================================================================

log_info() {
    echo -e "${CYAN}>>> $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ“ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš  $1${NC}"
}

log_error() {
    echo -e "${RED}âœ— $1${NC}"
}

# ============================================================================
# ì‚¬ì „ ì²´í¬
# ============================================================================

# Claude CLI í™•ì¸
if ! command -v claude &> /dev/null; then
    log_error "Claude CLIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    exit 1
fi

# tmp í´ë” ìƒì„±
mkdir -p "$TMP_DIR"

# ARCHITECTURE.md í™•ì¸
if [ ! -f "$ARCH_DOC" ]; then
    log_error "ARCHITECTURE.md íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $ARCH_DOC"
    exit 1
fi

# ============================================================================
# ë¦¬ë·° í”„ë¡¬í”„íŠ¸ ìƒì„± í•¨ìˆ˜
# ============================================================================

generate_prompt() {
    local layer=$1
    local layer_desc=$2
    local arch_content=$3
    local components=$4

    cat << EOF
ì‘ì—…: ${layer} ë ˆì´ì–´ ì»´í¬ë„ŒíŠ¸ ë¦¬ë·°

## ë ˆì´ì–´ ì •ë³´
- ë ˆì´ì–´: ${layer}
- ì„¤ëª…: ${layer_desc}

## ARCHITECTURE.md ë‚´ìš© (ê´€ë ¨ ì„¹ì…˜)
\`\`\`
${arch_content}
\`\`\`

## ì‹¤ì œ ì»´í¬ë„ŒíŠ¸ ëª©ë¡
${components}

## ë¦¬ë·° ì§€ì‹œì‚¬í•­
${layer} ë ˆì´ì–´ ì»´í¬ë„ŒíŠ¸ë¥¼ ë‹¤ìŒ í•­ëª©ìœ¼ë¡œ ì² ì €íˆ ë¦¬ë·°:

### 1. êµ¬ì¡° ì¼ì¹˜ì„± ê²€ì‚¬
- ARCHITECTURE.mdì™€ ì‹¤ì œ components/${layer}/ í´ë” êµ¬ì¡° ë¹„êµ
- ì¼ì¹˜/ëˆ„ë½/ì¶”ê°€ëœ ì»´í¬ë„ŒíŠ¸ ëª©ë¡í™”

### 2. ì˜ì¡´ì„± ë¶„ì„
- ê° ì»´í¬ë„ŒíŠ¸ì˜ CMakeLists.txt REQUIRES í•­ëª© ë¶„ì„
- ì˜ì¡´ ë°©í–¥ ê²€ì‚¬ (ìƒìœ„ ê³„ì¸µ â†’ í•˜ìœ„ ê³„ì¸µ)
- ìˆœí™˜ ì˜ì¡´ì„± (Circular Dependency) ë°œê²¬ ì‹œ ë³´ê³ 
- 5ê³„ì¸µ ê·œì¹™ ìœ„ë°˜ ì—¬ë¶€ (ì˜ˆ: 03_serviceê°€ 01_app ì˜ì¡´)

### 3. ì¸í„°í˜ì´ìŠ¤ ê²€ì‚¬
- ê° ì»´í¬ë„ŒíŠ¸ì˜ í—¤ë” íŒŒì¼(include/*.h) êµ¬ì¡° ê²€í† 
- ê³µê°œ API ëª…í™•ì„±
- extern "C" ì‚¬ìš© ì—¬ë¶€ (C++ ì»´í¬ë„ŒíŠ¸ì˜ ê²½ìš°)

### 4. ì½”ë“œ í’ˆì§ˆ ê¸°ì´ˆ ê²€ì‚¬
- ì£¼ì„ ì¡´ì¬ ì—¬ë¶€ (í•œê¸€ ì£¼ì„ ê¶Œì¥)
- ë„¤ì´ë° ê·œì¹™ ì¤€ìˆ˜ (snake_case, UPPER_SNAKE_CASE)
- íŒŒì¼ ë°°ì¹˜ ê·œì¹™ (ì†ŒìŠ¤ëŠ” ë£¨íŠ¸, í—¤ë”ëŠ” include/)

### 5. ì•„í‚¤í…ì²˜ ê·œì¹™ ì¤€ìˆ˜
- src/ í´ë” ë¯¸ì‚¬ìš© í™•ì¸
- ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì¤€ìˆ˜ ì—¬ë¶€
- ì ì ˆí•œ ê³„ì¸µ ë°°ì¹˜ ì—¬ë¶€

### 6. ê°œì„  ì œì•ˆ
- ìš°ì„ ìˆœìœ„ë³„ (ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ)ë¡œ ê°œì„  ì‚¬í•­ ì œì•ˆ
- ë¦¬íŒ©í† ë§ì´ í•„ìš”í•œ ì½”ë“œ ì§€ì •

## ì¶œë ¥ í˜•ì‹
ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë¦¬ë·° ê²°ê³¼ë¥¼ ì¶œë ¥:

# ${layer} ë ˆì´ì–´ ì»´í¬ë„ŒíŠ¸ ë¦¬ë·°

## 1. êµ¬ì¡° ì¼ì¹˜ì„±
### ë¬¸ì„œ vs ì‹¤ì œ êµ¬ì¡°
| í•­ëª© | ë¬¸ì„œ | ì‹¤ì œ | ìƒíƒœ |
|------|------|------|------|
| [ì»´í¬ë„ŒíŠ¸] | âœ… | âœ… | ì¼ì¹˜ |
| ... | ... | ... | ... |

### ì¼ì¹˜ ìš”ì•½
- ì¼ì¹˜: Nê°œ
- ëˆ„ë½: Nê°œ
- ì¶”ê°€: Nê°œ

## 2. ì˜ì¡´ì„± ë¶„ì„
### ì˜ì¡´ì„± ê·¸ë˜í”„
\`\`\`
[ì˜ì¡´ì„± ë‹¤ì´ì–´ê·¸ë¨]
\`\`\`

### ë¬¸ì œ ë°œê²¬
- ìˆœí™˜ ì˜ì¡´ì„±: [ìˆìŒ/ì—†ìŒ]
  - ìƒì„¸ ë‚´ìš©...
- ê³„ì¸µ ìœ„ë°˜: [ìˆìŒ/ì—†ìŒ]
  - ìƒì„¸ ë‚´ìš©...

## 3. ì¸í„°í˜ì´ìŠ¤ ê²€ì‚¬
| ì»´í¬ë„ŒíŠ¸ | í—¤ë” íŒŒì¼ | ê³µê°œ API | extern "C" | ìƒíƒœ |
|----------|-----------|----------|------------|------|
| ... | ... | ... | ... | ... |

## 4. ì½”ë“œ í’ˆì§ˆ
| ì»´í¬ë„ŒíŠ¸ | ì£¼ì„ | ë„¤ì´ë° | íŒŒì¼ ë°°ì¹˜ | ìƒíƒœ |
|----------|------|--------|-----------|------|
| ... | ... | ... | ... | ... |

## 5. ì•„í‚¤í…ì²˜ ê·œì¹™
| ê·œì¹™ | ìƒíƒœ | ë¹„ê³  |
|------|------|------|
| src/ ë¯¸ì‚¬ìš© | âœ…/âŒ | |
| ë‹¨ì¼ ì±…ì„ | âœ…/âš ï¸/âŒ | |
| ì ì • ê³„ì¸µ | âœ…/âš ï¸/âŒ | |

## 6. ê°œì„  ì œì•ˆ
### ğŸ”´ ë†’ìŒ ìš°ì„ ìˆœìœ„
1. [ë¬¸ì œì ] - í•´ê²° ë°©ì•ˆ

### ğŸŸ¡ ì¤‘ê°„ ìš°ì„ ìˆœìœ„
1. ...

### ğŸŸ¢ ë‚®ìŒ ìš°ì„ ìˆœìœ„
1. ...

## 7. ARCHITECTURE.md ìˆ˜ì • ì œì•ˆ
[í•„ìš”í•œ ê²½ìš° ë¬¸ì„œ ìˆ˜ì • ë‚´ìš©]
EOF
}

# ============================================================================
# ë ˆì´ì–´ë³„ ì»´í¬ë„ŒíŠ¸ ëª©ë¡ ì¶”ì¶œ
# ============================================================================

get_components() {
    local layer=$1
    local layer_path="$PROJECT_DIR/components/$layer"

    if [ ! -d "$layer_path" ]; then
        echo "(ë ˆì´ì–´ í´ë” ì—†ìŒ)"
        return
    fi

    # í•˜ìœ„ ì»´í¬ë„ŒíŠ¸ ëª©ë¡ ì¶”ì¶œ (include í´ë” ê¸°ì¤€)
    find "$layer_path" -mindepth 2 -maxdepth 5 -type d -name "include" 2>/dev/null | \
        sed "s|$layer_path/||" | sed 's|/include||' | sort | \
        while read -r comp; do
            if [ -n "$comp" ]; then
                echo "  - $comp"
            fi
        done
}

# ============================================================================
# ARCHITECTURE.mdì—ì„œ í•´ë‹¹ ë ˆì´ì–´ ì„¹ì…˜ ì¶”ì¶œ
# ============================================================================

get_arch_section() {
    local layer=$1
    local layer_name="${layer#*_}"  # 00_common â†’ common

    # ë ˆì´ì–´ ì´ë¦„ ë³€í™˜
    case "$layer_name" in
        common)    layer_title="00_common (ê³µí†µ)" ;;
        app)       layer_title="01_app (ì•±)" ;;
        presentation) layer_title="02_presentation (í”„ë ˆì  í…Œì´ì…˜)" ;;
        service)   layer_title="03_service (ì„œë¹„ìŠ¤)" ;;
        driver)    layer_title="04_driver (ë“œë¼ì´ë²„)" ;;
        hal)       layer_title="05_hal (HAL)" ;;
        *)         layer_title="$layer" ;;
    esac

    # ARCHITECTURE.mdì—ì„œ ê´€ë ¨ ì„¹ì…˜ ì¶”ì¶œ
    awk "
        /## 5ê³„ì¸µ ì•„í‚¤í…ì²˜/ { in_arch = 1 }
        in_arch && /$layer_title/ { in_layer = 1; print; next }
        in_layer && /^â”‚/ { print; next }
        in_layer && /^â””/ { print; next }
        in_layer && /^$/ { print; next }
        in_layer && /â”€â”€/ { in_layer = 0 }
    " "$ARCH_DOC"
}

# ============================================================================
# ë³‘ë ¬ ë¦¬ë·° ì‹¤í–‰
# ============================================================================

log_info "ì»´í¬ë„ŒíŠ¸ ë¦¬ë·° ì‹œì‘ (ë³‘ë ¬ ì‹¤í–‰)"
log_info "ë¦¬ë·° ê²°ê³¼: $TMP_DIR/"
echo ""

# ë°±ê·¸ë¼ìš´ë“œ í”„ë¡œì„¸ìŠ¤ ID ì €ì¥
PIDS=()

# ê° ë ˆì´ì–´ë³„ë¡œ ë³‘ë ¬ ì‹¤í–‰
for layer in "${LAYERS[@]}"; do
    layer_desc="${LAYER_DESC[$layer]}"
    output_file="$TMP_DIR/${layer}_review.md"

    # ì»´í¬ë„ŒíŠ¸ ëª©ë¡ ì¶”ì¶œ
    components=$(get_components "$layer")

    # ARCHITECTURE.md ì„¹ì…˜ ì¶”ì¶œ
    arch_section=$(get_arch_section "$layer")

    # í”„ë¡¬í”„íŠ¸ ìƒì„±
    prompt=$(generate_prompt "$layer" "$layer_desc" "$arch_section" "$components")

    # ë¡œê·¸ íŒŒì¼
    log_file="$TMP_DIR/${layer}_log.txt"

    # ë°±ê·¸ë¼ìš´ë“œë¡œ ì‹¤í–‰
    (
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] ${layer} ë¦¬ë·° ì‹œì‘..." > "$log_file"

        # Claude CLI ì‹¤í–‰
        result=$(echo "$prompt" | claude 2>&1)
        echo "$result" > "$output_file"

        # ì™„ë£Œ í‘œì‹œ
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] ${layer} ë¦¬ë·° ì™„ë£Œ" >> "$log_file"
    ) &

    PIDS+=($!)
    log_info "[${layer}] ë¦¬ë·° íƒœìŠ¤í¬ ì‹œì‘ (PID: ${PIDS[-1]})..."
done

echo ""
log_info "ëª¨ë“  ë¦¬ë·° íƒœìŠ¤í¬ê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤..."
log_info "ì§„í–‰ ìƒí™© í™•ì¸: tail -f $TMP_DIR/*_log.txt"
echo ""

# ============================================================================
# ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§
# ============================================================================

# ì™„ë£Œëœ íƒœìŠ¤í¬ í‘œì‹œ
completed=0
total=${#LAYERS[@]}

while [ $completed -lt $total ]; do
    sleep 2
    completed=0

    for layer in "${LAYERS[@]}"; do
        log_file="$TMP_DIR/${layer}_log.txt"
        output_file="$TMP_DIR/${layer}_review.md"

        # ë¡œê·¸ íŒŒì¼ì— ì™„ë£Œ ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
        if grep -q "ë¦¬ë·° ì™„ë£Œ" "$log_file" 2>/dev/null; then
            completed=$((completed + 1))

            # íŒŒì¼ í¬ê¸° í™•ì¸
            if [ -f "$output_file" ]; then
                size=$(wc -c < "$output_file")
                printf "   ${GREEN}âœ“${NC} %-20s : ì™„ë£Œ (%d bytes)\n" "$layer" "$size"
            fi
        else
            printf "   ${YELLOW}â—‹${NC} %-20s : ì§„í–‰ ì¤‘...\n" "$layer"
        fi
    done

    # ì»¤ì„œë¥¼ ìœ„ë¡œ ì´ë™í•´ì„œ ë®ì–´ì“°ê¸°
    if [ $completed -lt $total ]; then
        printf "\033[%dA" "$total"
    fi
done

echo ""
log_success "ëª¨ë“  ë¦¬ë·° ì™„ë£Œ!"
echo ""

# ============================================================================
# ê²°ê³¼ ìš”ì•½
# ============================================================================

log_info "ë¦¬ë·° ê²°ê³¼ íŒŒì¼:"
echo ""

for layer in "${LAYERS[@]}"; do
    output_file="$TMP_DIR/${layer}_review.md"
    if [ -f "$output_file" ]; then
        size=$(wc -l < "$output_file")
        printf "  %-20s â†’ %d lines\n" "$layer" "$size"
    fi
done

echo ""
log_info "ì „ì²´ ë¦¬ë·° ë³´ê¸°:"
echo "  cat $TMP_DIR/*_review.md"
echo ""
