<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EoRa-S3 설정</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>EoRa-S3 네트워크 설정</h1>
            <div id="status-badge" class="badge">연결 중...</div>
        </header>

        <!-- 네트워크 상태 -->
        <section class="card">
            <h2>네트워크 상태</h2>
            <div class="status-grid">
                <div class="status-item">
                    <h3>WiFi AP</h3>
                    <div id="wifi-ap-status">로딩 중...</div>
                </div>
                <div class="status-item">
                    <h3>WiFi STA</h3>
                    <div id="wifi-sta-status">로딩 중...</div>
                </div>
                <div class="status-item">
                    <h3>Ethernet</h3>
                    <div id="eth-status">로딩 중...</div>
                </div>
            </div>
        </section>

        <!-- WiFi STA 설정 -->
        <section class="card">
            <h2>WiFi STA 설정</h2>
            <div class="form-group">
                <button id="wifi-scan-btn" class="btn btn-secondary">WiFi 네트워크 검색</button>
                <span id="wifi-scan-status" style="margin-left: 10px;"></span>
            </div>
            <div id="wifi-scan-results" class="wifi-scan-results" style="display: none;">
                <!-- 스캔 결과가 여기에 동적으로 추가됨 -->
            </div>
            <form id="wifi-sta-form">
                <div class="form-group">
                    <label for="wifi-ssid">SSID</label>
                    <input type="text" id="wifi-ssid" name="ssid" required>
                </div>
                <div class="form-group">
                    <label for="wifi-password">비밀번호</label>
                    <input type="password" id="wifi-password" name="password">
                </div>
                <button type="submit" class="btn btn-primary">저장</button>
            </form>
        </section>

        <!-- Ethernet 설정 -->
        <section class="card">
            <h2>Ethernet 설정</h2>
            <form id="eth-form">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="eth-dhcp" name="dhcp_enabled">
                        DHCP 사용
                    </label>
                </div>
                <div id="eth-static-fields">
                    <div class="form-group">
                        <label for="eth-ip">IP 주소</label>
                        <input type="text" id="eth-ip" name="static_ip" pattern="\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}">
                    </div>
                    <div class="form-group">
                        <label for="eth-netmask">넷마스크</label>
                        <input type="text" id="eth-netmask" name="static_netmask" pattern="\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}">
                    </div>
                    <div class="form-group">
                        <label for="eth-gateway">게이트웨이</label>
                        <input type="text" id="eth-gateway" name="static_gateway" pattern="\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">저장</button>
            </form>
        </section>

        <!-- 스위처 설정 -->
        <section class="card">
            <h2>스위처 설정</h2>

            <!-- 모드 선택 -->
            <div class="form-group">
                <label for="switcher-mode-select">동작 모드</label>
                <select id="switcher-mode-select" class="mode-select">
                    <option value="single">싱글 모드 (Primary만)</option>
                    <option value="dual">듀얼 모드 (Primary + Secondary)</option>
                </select>
                <button id="save-mode-btn" class="btn btn-primary" style="margin-left: 10px;">모드 저장</button>
                <button id="restart-switcher-btn" class="btn btn-warning" style="margin-left: 10px;">연결 재시작</button>
            </div>

            <!-- 스위처 상태 요약 -->
            <div class="switcher-status-summary">
                <div class="status-item">
                    <h4>현재 모드</h4>
                    <div id="switcher-mode" class="badge">로딩 중...</div>
                </div>
                <div class="status-item">
                    <h4>활성 스위처</h4>
                    <div id="switcher-active-count">로딩 중...</div>
                </div>
            </div>

            <div id="switcher-config">
                <!-- Primary Switcher -->
                <div class="switcher-item">
                    <h3>Primary Switcher
                        <span id="sw0-status-badge" class="badge">로딩 중...</span>
                    </h3>
                    <div id="sw0-connection-info" class="connection-info"></div>
                    <button class="btn btn-primary" onclick="openSwitcherModal(0)">설정</button>
                </div>

                <!-- Secondary Switcher -->
                <div class="switcher-item">
                    <h3>Secondary Switcher
                        <span id="sw1-status-badge" class="badge">로딩 중...</span>
                    </h3>
                    <div id="sw1-connection-info" class="connection-info"></div>
                    <button class="btn btn-primary" onclick="openSwitcherModal(1)">설정</button>
                </div>
            </div>

            <!-- 카메라 매핑 비주얼 설정 -->
            <div class="mapping-visual-section">
                <h3>카메라 번호 매핑</h3>
                <div class="mapping-info">
                    <div class="info-item">
                        <span class="color-box primary-color"></span>
                        <span>Primary Switcher</span>
                    </div>
                    <div class="info-item">
                        <span class="color-box secondary-color"></span>
                        <span>Secondary Switcher</span>
                    </div>
                </div>
                <div class="camera-buttons" id="camera-mapping-buttons">
                    <!-- 버튼들은 JavaScript로 동적 생성 -->
                </div>
                <div class="mapping-controls">
                    <p><strong>Secondary 시작 위치:</strong> <span id="secondary-start-pos">-</span></p>
                    <button id="save-mapping-btn" class="btn btn-primary">매핑 저장</button>
                </div>
            </div>
        </section>

        <!-- 시스템 상태 -->
        <section class="card">
            <h2>시스템 상태</h2>
            <div class="health-grid">
                <div class="health-item">
                    <h3>전체 상태</h3>
                    <div id="health-overall" class="health-value">로딩 중...</div>
                </div>
                <div class="health-item">
                    <h3>업타임</h3>
                    <div id="health-uptime" class="health-value">로딩 중...</div>
                </div>
                <div class="health-item">
                    <h3>전압</h3>
                    <div id="health-voltage" class="health-value">로딩 중...</div>
                </div>
                <div class="health-item">
                    <h3>배터리</h3>
                    <div id="health-battery" class="health-value">로딩 중...</div>
                </div>
                <div class="health-item">
                    <h3>메모리</h3>
                    <div id="health-memory" class="health-value">로딩 중...</div>
                </div>
                <div class="health-item">
                    <h3>온도</h3>
                    <div id="health-temperature" class="health-value">로딩 중...</div>
                </div>
                <div class="health-item">
                    <h3>CPU 사용률</h3>
                    <div id="health-cpu" class="health-value">로딩 중...</div>
                </div>
            </div>
        </section>

        <!-- LoRa 설정 -->
        <section class="card">
            <h2>LoRa 통신 설정</h2>

            <!-- LoRa 상태 -->
            <div class="lora-status-grid">
                <div class="status-item">
                    <h4>칩</h4>
                    <div id="lora-chip" class="badge">로딩 중...</div>
                </div>
                <div class="status-item">
                    <h4>주파수</h4>
                    <div id="lora-frequency">-</div>
                </div>
            </div>

            <!-- 주파수 스캔 -->
            <div class="form-group">
                <h3>주파수 채널 스캔</h3>
                <div style="margin-bottom: 10px; color: #666; font-size: 14px;">
                    스캔 범위: <span id="scan-range-display">-</span>
                </div>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button id="lora-scan-btn" class="btn btn-secondary">스캔 시작</button>
                    <span id="lora-scan-status"></span>
                </div>
                <div id="lora-scan-results" style="margin-top: 15px; display: none;">
                    <h4>스캔 결과</h4>
                    <div id="lora-scan-chart" class="scan-chart"></div>
                </div>
            </div>

            <!-- 주파수 변경 -->
            <div class="form-group">
                <h3>주파수 설정 (임시)</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label for="lora-freq-input">주파수 (MHz):</label>
                    <input type="number" id="lora-freq-input" step="0.1" style="width: 100px;">
                    <button id="lora-freq-save-btn" class="btn btn-secondary">임시 저장</button>
                    <span id="freq-pending-badge" style="display:none; color: orange; font-size: 20px;">●</span>
                </div>
                <small id="freq-range-hint" style="color: #666;">-</small>
            </div>

            <!-- Sync Word 변경 -->
            <div class="form-group">
                <h3>Sync Word 설정 (임시)</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label for="lora-sync-input">Sync Word:</label>
                    <input type="range" id="lora-sync-input" min="0" max="255" value="18" style="flex: 1; max-width: 300px;">
                    <span id="lora-sync-value" style="font-weight: bold; min-width: 60px;">0x12</span>
                    <button id="lora-sync-save-btn" class="btn btn-secondary">임시 저장</button>
                    <span id="sync-pending-badge" style="display:none; color: orange; font-size: 20px;">●</span>
                </div>
                <small style="color: #666;">같은 Sync Word를 가진 장치끼리만 통신 가능 (네트워크 분리, 0x00~0xFF)</small>
            </div>

            <!-- 설정 적용 -->
            <div class="form-group" style="margin-top: 25px; padding: 20px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px;">
                <h3 style="margin-top: 0;">⚠️ 설정 적용</h3>
                <p style="margin: 10px 0; color: #856404; line-height: 1.6;">
                    위에서 임시 저장한 설정을 실제로 적용합니다.<br>
                    <strong>RX 장치에 3회 알림을 보낸 후 TX도 변경됩니다.</strong><br>
                    <small>(총 소요 시간: 약 4초)</small>
                </p>
                <button id="lora-apply-btn" class="btn btn-primary" style="font-size: 16px; padding: 12px 24px;">
                    설정 적용하기
                </button>
                <div id="lora-apply-status" style="margin-top: 15px; font-weight: bold;"></div>
            </div>
        </section>

        <!-- 시스템 제어 -->
        <section class="card">
            <h2>시스템 제어</h2>
            <button id="restart-btn" class="btn btn-danger">시스템 재시작</button>
        </section>

        <footer>
            <p>EoRa-S3 Firmware v1.0</p>
        </footer>
    </div>

    <!-- 스위처 설정 모달 -->
    <div id="switcher-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">스위처 설정</h2>
                <span class="modal-close" onclick="closeSwitcherModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="modal-switcher-form">
                    <input type="hidden" id="modal-index" value="0">

                    <div class="form-group">
                        <label for="modal-type">타입</label>
                        <select id="modal-type" name="type">
                            <option value="1">ATEM</option>
                            <option value="2">vMix</option>
                            <option value="3">OBS</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="modal-interface">통신 방식</label>
                        <select id="modal-interface" name="interface">
                            <option value="1">WiFi STA</option>
                            <option value="2">Ethernet</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="modal-ip">IP 주소</label>
                        <input type="text" id="modal-ip" name="ip" pattern="\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}" required>
                    </div>

                    <div class="form-group" id="modal-password-group">
                        <label for="modal-password">비밀번호</label>
                        <input type="password" id="modal-password" name="password">
                    </div>

                    <div class="form-group">
                        <label for="modal-camera-limit">Camera Limit (0=자동)</label>
                        <input type="number" id="modal-camera-limit" name="camera_limit" min="0" max="20" value="0">
                        <small style="color: #666;">카메라 개수 제한 (0=자동 감지)</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button id="modal-save-btn" class="btn btn-primary">저장</button>
            </div>
        </div>
    </div>

    <!-- 토스트 메시지 컨테이너 -->
    <div id="toast-container" class="toast-container"></div>

    <script src="/app.js"></script>
</body>
</html>
